<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZZZç¥ç§˜å°ç®—ç›˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @font-face {
            font-family: 'HanYiQiHei105';
            src: url('HanYiQiHei105.woff2') format('woff2');
        }

        :root {
            --zzz-neon: #dfff00;
            --zzz-black: #0a0a0a;
            --zzz-panel: rgba(20, 20, 20, 0.9);
            --zzz-border: #444;
            --zzz-text-main: #ffffff;
            --zzz-text-dim: #888;
            --zzz-alert: #ff003c;
        }

        * { box-sizing: border-box; }

        body {
            background-color: #000;
            color: var(--zzz-text-main);
            font-family: 'HYQiHei-105', 'Industry', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(223, 255, 0, 0.05) 0%, transparent 60%),
                linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.9) 100%),
                repeating-linear-gradient(45deg, #111 0px, #111 1px, transparent 1px, transparent 10px);
            min-height: 100vh;
        }


        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 50px;
            position: relative;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--zzz-border);
        }

        h1 {
            font-size: 3.5rem;
            color: var(--zzz-neon);
            text-transform: uppercase;
            letter-spacing: 8px;
            margin: 0;
            text-shadow: 0 0 10px rgba(223, 255, 0, 0.5);
            font-style: italic;
        }

        .credits {
            font-family: monospace;
            color: var(--zzz-text-dim);
            margin-top: 5px;
        }

        .version {
            display: inline-block;
            background: var(--zzz-neon);
            color: #000;
            font-weight: 900;
            padding: 2px 10px;
            font-size: 0.8rem;
            transform: skew(-15deg);
            margin-top: 10px;
        }

        /* Module Layout */
        .module {
            background: var(--zzz-panel);
            border: 1px solid var(--zzz-border);
            margin-bottom: 30px;
            padding: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            border-radius: 4px;
        }

        .module::after {
            content: '';
            position: absolute;
            bottom: -5px; right: -5px;
            width: 20px; height: 20px;
            border-bottom: 3px solid var(--zzz-neon);
            border-right: 3px solid var(--zzz-neon);
        }

        .module-title {
            position: absolute;
            top: -15px;
            left: 20px;
            background: var(--zzz-neon);
            color: #000;
            padding: 5px 20px;
            font-weight: 900;
            font-size: 1.2rem;
            transform: skew(-15deg);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
        }

        .module-title span { display: block; transform: skew(15deg); }

        /* Grid Systems */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .grid-2-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .grid-2-split { grid-template-columns: 1fr; }
        }

        /* Sub-Modules */
        .sub-module {
            border-left: 2px solid var(--zzz-border);
            padding: 15px;
            background: rgba(255,255,255,0.02);
            transition: border-color 0.3s;
        }
        .sub-module:hover { border-left-color: var(--zzz-neon); }

        .sub-module h3 {
            color: var(--zzz-neon);
            margin: 0 0 15px 0;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Inputs */
        .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        label { color: var(--zzz-text-dim); }

        input[type="number"], input[type="text"], select {
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            color: var(--zzz-neon);
            padding: 6px 10px;
            width: 100px;
            font-family: monospace;
            text-align: right;
            font-size: 1rem;
            transition: all 0.2s;
        }

        select {
            width: auto;
            min-width: 120px;
            max-width: 180px;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            text-align: left;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--zzz-neon);
            box-shadow: 0 0 10px rgba(223, 255, 0, 0.2);
        }

        /* Buttons & Switches */
        .zzz-btn {
            background: transparent;
            border: 1px solid var(--zzz-text-dim);
            color: var(--zzz-text-dim);
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .zzz-btn.active {
            background: var(--zzz-neon);
            color: #000;
            border-color: var(--zzz-neon);
            box-shadow: 0 0 15px rgba(223, 255, 0, 0.4);
        }

        .zzz-btn:hover:not(.active) {
            border-color: var(--zzz-neon);
            color: var(--zzz-neon);
        }

        .switch-container { display: flex; gap: 5px; }

        /* Cinema & Star Buttons */
        .rank-selector {
            display: flex;
            gap: 4px;
            margin-left: 10px;
        }
        .rank-btn {
            width: 24px;
            height: 24px;
            border: 1px solid #444;
            background: #111;
            color: #666;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .rank-btn.active {
            background: var(--zzz-neon);
            color: #000;
            border-color: var(--zzz-neon);
            box-shadow: 0 0 5px var(--zzz-neon);
        }

        /* Calculation Log */
        .calc-log {
            background: #000;
            border: 1px solid var(--zzz-neon);
            padding: 20px;
            font-family: 'Consolas', monospace;
            color: #fff;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.95rem;
            position: relative;
        }
        .in-combat-highlight { color: var(--zzz-neon); font-weight: bold; }
        .alert-text { color: var(--zzz-alert); font-weight: bold; }
        
        /* Tooltips */
        .u-tooltip {
            border-bottom: 1px dotted var(--zzz-neon);
            cursor: help;
            position: relative;
        }
        .u-tooltip .u-tooltip-content {
            visibility: hidden;
            position: absolute;
            bottom: 120%; left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--zzz-neon);
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            z-index: 100;
            font-size: 0.85rem;
            min-width: 220px;
            text-align: left;
            line-height: 1.4;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .u-tooltip:hover .u-tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        .u-tooltip-title {
            color: var(--zzz-neon);
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        /* Chart & Opt */
        .opt-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(223, 255, 0, 0.05);
            border: 1px solid var(--zzz-border);
            align-items: center;
        }

        /* Enlarged Buttons */
        .btn-large {
            padding: 10px 25px;
            font-size: 1rem;
            letter-spacing: 1px;
        }

        .chart-wrapper {
            height: 450px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--zzz-border);
            padding: 10px;
        }

        .panel-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 0.9rem;
        }
        .panel-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #222;
            padding: 5px 0;
        }
        .panel-row span:last-child { color: var(--zzz-neon); font-family: monospace; font-size: 1.1rem; }

        .opt-config-box {
            background: rgba(223, 255, 0, 0.1);
            border: 1px solid var(--zzz-neon);
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        .opt-config-title { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .opt-config-val { font-size: 1.2rem; font-weight: bold; color: var(--zzz-neon); }
        .opt-sub-stats { font-size: 0.9rem; color: #fff; margin-top: 5px; }

        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: #111;
            border: 2px solid var(--zzz-neon);
            padding: 40px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 30px rgba(223, 255, 0, 0.2);
            transform: skew(-5deg);
        }
        .modal h2 { color: var(--zzz-neon); margin-top: 0; }
        .modal p { color: #ccc; line-height: 1.6; margin-bottom: 30px; }

    </style>
</head>
<body>

<!-- Startup Modal -->
<div id="welcome-modal" class="modal">
    <div class="modal-content">
        <h2>ä½¿ç”¨é¡»çŸ¥</h2>
        <p>
            æ¬¢è¿ä½¿ç”¨ ZZZç¥ç§˜å°ç®—ç›˜<br>
            æœ¬å·¥å…·ä»…ä¾›æ•°æ®æ¨¡æ‹Ÿä¸é…è£…å‚è€ƒã€‚<br>
            <br>
            tiPs<br>
            1. é€‰å–ä¸»Cä»£ç†äººå’Œè¾…åŠ©ä»£ç†äººï¼Œä»¥åŠä»–ä»¬çš„å½±ç”»ã€‚<br>
            2. é€‰å–ä»£ç†äººçš„éŸ³æ“ï¼Œä»¥åŠæ­¦å™¨çš„ç²¾ç‚¼ç­‰çº§ã€‚<br>
            3. æ‰‹åŠ¨è°ƒæ•´æ•Œäººæ•°æ®å’Œåœºåœ°BUFFã€‚<br>
            4. 4ä»¶å¥—å±æ€§ä¼šç›´æ¥åŠ ç®—è¿›è¯¥ä»£ç†äººçš„é¢æ¿ä¸­ã€‚<br>
        </p>
        <button class="zzz-btn btn-large active" onclick="closeModal()">å¼€å§‹è®¡ç®—</button>
    </div>
</div>

<div class="container">
    <header>
        <h1>ZZZç¥ç§˜å°ç®—ç›˜</h1>
        <div class="credits">bY å¥¥ä¼¯å‹’æ–¯çš„åƒæ—©çˆ±éŸ³æœ¬äºº with Dr.Gemini</div>
        <div class="version">ver1217</div>
        <div style="margin-top: 15px;">
            <button class="zzz-btn" id="export-btn" onclick="exportSnapshot()">ğŸ“¸ å¯¼å‡ºé…ç½®é•¿å›¾</button>
        </div>
    </header>

    <!-- Module 1: Agent Data -->
    <div class="module" id="mod-agent">
        <div class="module-title"><span>01 // ä»£ç†äººæ•°æ®</span></div>
        <div class="grid-3">
            <!-- Main DPS -->
            <div class="sub-module" id="agent-main">
                <h3>ä¸»Cä»£ç†äºº (DPS)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-dps-select" onchange="loadPreset('dps', 'a_main', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="cinema-a_main">
                            <!-- JS generates buttons -->
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>4ä»¶å¥—</label>
                    <select id="set4-a_main" onchange="calculateAll()"></select>
                </div>
                <!-- Inputs generated by JS -->
            </div>
            <!-- Support 1 -->
            <div class="sub-module" id="agent-sup1">
                <h3>è¾…åŠ© 1 (SUP)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-sup1-select" onchange="loadPreset('sup', 'a_sup1', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="cinema-a_sup1"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>4ä»¶å¥—</label>
                    <select id="set4-a_sup1" onchange="calculateAll()"></select>
                </div>
            </div>
            <!-- Support 2 -->
            <div class="sub-module" id="agent-sup2">
                <h3>è¾…åŠ© 2 (SUP)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-sup2-select" onchange="loadPreset('sup', 'a_sup2', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="cinema-a_sup2"></div>
                    </div>
                </div>
                <div class="input-group">
                    <label>4ä»¶å¥—</label>
                    <select id="set4-a_sup2" onchange="calculateAll()"></select>
                </div>
            </div>
        </div>
    </div>

    <!-- Module 2: W-Engine Data -->
    <div class="module" id="mod-weapon">
        <div class="module-title"><span>02 // éŸ³æ“æ•°æ®</span></div>
        <div class="grid-3">
            <!-- Main Weapon -->
            <div class="sub-module" id="weapon-main">
                <h3>ä¸»CéŸ³æ“ (wpDPS)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-wdps-select" onchange="loadPreset('wpDPS', 'w_main', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="star-w_main"></div>
                    </div>
                </div>
            </div>
            <!-- Sup1 Weapon -->
            <div class="sub-module" id="weapon-sup1">
                <h3>è¾…åŠ©1éŸ³æ“ (wpSUP)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-wsup1-select" onchange="loadPreset('wpSUP', 'w_sup1', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="star-w_sup1"></div>
                    </div>
                </div>
            </div>
            <!-- Sup2 Weapon -->
            <div class="sub-module" id="weapon-sup2">
                <h3>è¾…åŠ©2éŸ³æ“ (wpSUP)</h3>
                <div class="input-group">
                    <label>é¢„è®¾æ–‡ä»¶</label>
                    <div style="display:flex; align-items:center;">
                        <select id="preset-wsup2-select" onchange="loadPreset('wpSUP', 'w_sup2', this.value)">
                            <option value="">-- åŠ è½½ä¸­... --</option>
                        </select>
                        <div class="rank-selector" id="star-w_sup2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module 3 & 4: Split Layout -->
    <div class="grid-2-split">
        <!-- Module 3: Disc Stats -->
        <div class="module" id="mod-preset-stats">
            <div class="module-title"><span>03 // é©±åŠ¨ç›˜ä¸»è¯æ¡</span></div>
            <div class="sub-module">
                <div class="input-group">
                    <label>6å·ä½ (å›ºå®š)</label>
                    <input type="text" value="30% æ”»å‡»åŠ›" disabled>
                </div>
                <div class="input-group">
                    <label>2å·ä½ (å›ºå®š)</label>
                    <input type="text" value="316 å›ºå®šæ”»å‡»" disabled>
                </div>
                <div class="input-group">
                    <label>4å·ä½ (å¯é€‰)</label>
                    <select id="slot4-select" onchange="calculateAll()">
                        <option value="critRate">24% æš´å‡»ç‡</option>
                        <option value="critDmg">48% æš´å‡»ä¼¤å®³</option>
                        <option value="atk">30% æ”»å‡»åŠ›</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Module 4: BOSS Data -->
        <div class="module" id="mod-boss">
            <div class="module-title"><span>04 // æ•Œäººæ•°æ®</span></div>
            <div class="sub-module">
                <div class="input-group">
                    <label>åŸºç¡€é˜²å¾¡åŠ›</label>
                    <select id="boss-def-base" onchange="calculateAll()">
                        <option value="953">é»˜è®¤ (953)</option>
                        <option value="1588">å½·å¾¨çŒæ‰‹ (1588)</option>
                        <option value="476">å¤ªåˆæ¢¦é­‡ (476)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>é˜²å¾¡åŠ æˆ (%)</label>
                    <input type="number" id="boss-def-bonus" value="0" onchange="calculateAll()">
                </div>
                <div class="input-group">
                    <label>æ•ŒäººæŠ—æ€§</label>
                    <div class="switch-container">
                        <button class="zzz-btn active" onclick="setRes(0, this)">0%</button>
                        <button class="zzz-btn" onclick="setRes(0.2, this)">20%</button>
                        <button class="zzz-btn" onclick="setRes(0.4, this)">40%</button>
                    </div>
                </div>
                <div class="input-group" style="margin-top:10px;">
                    <label>æ•Œäººå¼±ç‚¹</label>
                    <div class="switch-container">
                        <button class="zzz-btn" onclick="setWeakness(true, this)">æ˜¯</button>
                        <button class="zzz-btn active" onclick="setWeakness(false, this)">å¦</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Module 5: Optimization (Moved Up) -->
    <div class="module" id="mod-opt">
        <div class="module-title"><span>05 // è°ƒä¼˜ä¸æ¨¡æ‹Ÿ</span></div>
        
        <!-- Field Buffs (New) -->
        <div class="sub-module" style="margin-bottom: 20px; border-color: var(--zzz-neon);">
            <h3>åœºåœ°BUFF (å…¨å±€ç”Ÿæ•ˆ)</h3>
            <div class="grid-3">
                <div class="input-group"><label>å±€å†…æ”»å‡»%</label><input type="number" id="field_inCombatAtkPct" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>æš´å‡»ç‡%</label><input type="number" id="field_critRate" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>æš´å‡»ä¼¤å®³%</label><input type="number" id="field_critDmg" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>å¢ä¼¤%</label><input type="number" id="field_dmgBonus" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>å‡æŠ—%</label><input type="number" id="field_resShred" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>æ— è§†é˜²å¾¡%</label><input type="number" id="field_defShred" value="0" onchange="calculateAll()"></div>
                <div class="input-group"><label>å¤±è¡¡æ˜“ä¼¤%</label><input type="number" id="field_dazeVuln" value="0" onchange="calculateAll()"></div>
            </div>
        </div>

        <div class="opt-controls">
            <button class="zzz-btn btn-large active" id="mode-manual-btn" onclick="switchMode('manual')">æ‰‹åŠ¨æ¨¡å¼</button>
            <button class="zzz-btn btn-large" id="mode-auto-btn" onclick="switchMode('auto')">æœ€ä¼˜è®¡ç®—</button>
        </div>

        <!-- Manual Mode UI -->
        <div id="manual-ui">
            <div class="grid-3">
                <div class="sub-module">
                    <h3>å‰¯è¯æ¡æ•°é‡ (æ€»å’Œ â‰¤ 48)</h3>
                    <div class="input-group">
                        <label>æš´å‡»ç‡ (2.4%)</label>
                        <input type="number" id="sub-cr-count" value="0" min="0" onchange="calculateAll()">
                        <span id="gain-cr" style="color:var(--zzz-neon); font-size:0.8rem;"></span>
                    </div>
                    <div class="input-group">
                        <label>æš´å‡»ä¼¤å®³ (4.8%)</label>
                        <input type="number" id="sub-cd-count" value="0" min="0" onchange="calculateAll()">
                        <span id="gain-cd" style="color:var(--zzz-neon); font-size:0.8rem;"></span>
                    </div>
                    <div class="input-group">
                        <label>æ”»å‡»åŠ› (3%)</label>
                        <input type="number" id="sub-atk-count" value="0" min="0" onchange="calculateAll()">
                        <span id="gain-atk" style="color:var(--zzz-neon); font-size:0.8rem;"></span>
                    </div>
                    <div style="text-align:right; color:var(--zzz-alert); font-size:0.8rem;" id="sub-total-warn"></div>
                </div>
                <div class="sub-module">
                    <h3>è£…å¤‡é€‰æ‹©</h3>
                    <div class="input-group">
                        <label>5å·ä½ä¸»è¯æ¡</label>
                        <select id="slot5-select" onchange="calculateAll()">
                            <option value="atk">30% æ”»å‡»åŠ›</option>
                            <option value="dmg">30% å¢ä¼¤</option>
                            <option value="pen">24% ç©¿é€ç‡</option>
                        </select>
                    </div>
                    <div style="text-align:right; font-size:0.8rem; color:var(--zzz-neon)" id="gain-slot5"></div>
                    
                    <div class="input-group">
                        <label>2ä»¶å¥—æ•ˆæœ</label>
                        <select id="set2-select" onchange="calculateAll()">
                            <option value="dmg">10% å¢ä¼¤</option>
                            <option value="pen">8% ç©¿é€ç‡</option>
                            <option value="atk">10% æ”»å‡»åŠ›</option>
                            <option value="cd">16% æš´å‡»ä¼¤å®³</option>
                        </select>
                    </div>
                    <div style="text-align:right; font-size:0.8rem; color:var(--zzz-neon)" id="gain-set2"></div>
                </div>
                <div class="sub-module">
                    <h3>æœ€ç»ˆé¢æ¿ (æ‰‹åŠ¨)</h3>
                    <div id="manual-panel" class="panel-data"></div>
                </div>
            </div>
        </div>

        <!-- Auto Mode UI -->
        <div id="auto-ui" style="display:none;">
            <div class="opt-controls">
                <label style="color:#fff; margin-right:10px;">æŸ¥çœ‹èŠ‚ç‚¹ï¼š</label>
                <button class="zzz-btn btn-large" id="btn-30" onclick="updateChartLine(30)">30è¯</button>
                <button class="zzz-btn btn-large" id="btn-36" onclick="updateChartLine(36)">36è¯</button>
                <button class="zzz-btn btn-large" id="btn-42" onclick="updateChartLine(42)">42è¯</button>
            </div>
            
            <div class="grid-3">
                <div class="sub-module" style="grid-column: span 2;">
                    <div class="chart-wrapper">
                        <canvas id="optChart"></canvas>
                    </div>
                </div>
                <div class="sub-module">
                    <h3>æœ€ä¼˜é…è£…æ–¹æ¡ˆ</h3>
                    <div id="opt-config-display" class="opt-config-box">
                        <div class="opt-config-title">æ¨èæ­é…</div>
                        <div class="opt-config-val" id="opt-config-val">--</div>
                        <div class="opt-sub-stats" id="opt-sub-stats">--</div>
                    </div>

                    <h3>æœ€ç»ˆé¢æ¿ (æœ€ä¼˜)</h3>
                    <div id="opt-panel" class="panel-data">
                        <!-- Stats here -->
                    </div>
                    
                    <h3 style="margin-top:20px;">ç†è®ºæé™ä¼¤å®³</h3>
                    <div id="opt-dmg" style="font-size:2rem; color:var(--zzz-neon); text-align:right; text-shadow:0 0 10px var(--zzz-neon);"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Module 6: Calculation Process (Moved Down) -->
    <div class="module" id="mod-calc">
        <div class="module-title"><span>06 // ä¼¤å®³è®¡ç®—æ ¸å¿ƒ</span></div>
        <div class="input-group" style="max-width: 300px;">
            <label>æŠ€èƒ½å€ç‡ (%)</label>
            <input type="number" id="skill-multiplier" value="100" onchange="calculateAll()">
        </div>
        <div class="calc-log" id="calc-log">
            ç­‰å¾…è®¡ç®—...
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION: FILE MANIFEST ---
    const REPO_FILES = {
        dps: ["å¶ç¬å…‰.json", "11å·â…¥.json"], 
        sup: ["ç‰éŸ³.json", "ç…§.json", "è€€å˜‰éŸ³.json", "è±ç‰¹.json"], 
        wpDPS: ["äº‘éœ“å­¤å…‰.json", "ç¡«ç£ºçŸ³.json"], 
        wpSUP: ["æ˜¨å¤œæ¥ç”µ.json", "åŠç³–é›ªå…”.json", "å¥½æ–—çš„é˜¿ç‚®.json", "ç²ç‘å¦†åŒ£.json", "ç„°å¿ƒæ¡‚å† .json"] 
    };

    // --- DISC 4-SET DATA ---
    const DISC_4_SETS = {
        "none": { name: "-- æ— å¥—è£… --", stats: {} },
        "canglang": { name: "æ²§æµªè¡Œæ­Œ", stats: { dmgBonus: 10, critRate: 20, inCombatAtkPct: 10 } },
        "moon": { name: "æœˆå…‰éª‘å£«é¢‚", stats: { dmgBonus: 18 } },
        "mountain": { name: "å±±å¤§ç‹", stats: { critDmg: 30 } },
        "listen": { name: "é™å¬å˜‰éŸ³", stats: { dmgBonus: 24 } } 
    };

    // --- Data Definitions ---
    const agentFields = [
        {id: 'baseAtk', label: 'åŸºç¡€æ”»å‡»', def: 0},
        {id: 'critRate', label: 'æš´å‡»ç‡%', def: 5},
        {id: 'critDmg', label: 'æš´å‡»ä¼¤å®³%', def: 50},
        {id: 'dmgBonus', label: 'å¢ä¼¤%', def: 0},
        {id: 'penRatio', label: 'ç©¿é€ç‡%', def: 0},
        {id: 'penValue', label: 'ç©¿é€å€¼', def: 0},
        {id: 'defShred', label: 'æ— è§†é˜²å¾¡(å‡é˜²)%', def: 0},
        {id: 'dazeVuln', label: 'å¤±è¡¡æ˜“ä¼¤%', def: 0},
        {id: 'resShred', label: 'å‡æŠ—%', def: 0},
        {id: 'inCombatAtkPct', label: 'å±€å†…æ”»å‡»%', def: 0},
        {id: 'inCombatAtkFlat', label: 'å±€å†…å›ºå®šæ”»å‡»', def: 0}
    ];

    const weaponFields = [
        {id: 'baseAtk', label: 'åŸºç¡€æ”»å‡»', def: 0},
        {id: 'critRate', label: 'æš´å‡»ç‡%', def: 0},
        {id: 'critDmg', label: 'æš´å‡»ä¼¤å®³%', def: 0},
        {id: 'atkPct', label: 'æ”»å‡»åŠ›%', def: 0},
        {id: 'penRatio', label: 'ç©¿é€ç‡%', def: 0},
        {id: 'defShred', label: 'æ— è§†é˜²å¾¡%', def: 0},
        {id: 'resShred', label: 'å‡æŠ—%', def: 0},
        {id: 'dmgBonus', label: 'å¢ä¼¤%', def: 0},
        {id: 'inCombatAtkPct', label: 'å±€å†…æ”»å‡»%', def: 0},
        {id: 'inCombatAtkFlat', label: 'å±€å†…å›ºå®šæ”»å‡»', def: 0}
    ];

    // --- Global State ---
    let globalState = {
        bossRes: 0,
        bossWeak: false,
        mode: 'manual',
        chart: null,
        optData: [], // active display data
        allOptResults: [], // cache of all simulation combos
        rawPresets: {}, // Stores the raw JSON loaded from files
        configs: {
            a_main: { cinema: 0 },
            a_sup1: { cinema: 0 },
            a_sup2: { cinema: 0 },
            w_main: { star: 1 },
            w_sup1: { star: 1 },
            w_sup2: { star: 1 }
        }
    };

    // --- Initialization ---
    function createInputs(containerId, prefix, fields) {
        const container = document.getElementById(containerId);
        fields.forEach(f => {
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <label>${f.label}</label>
                <input type="number" id="${prefix}_${f.id}" value="${f.def}" onchange="calculateAll()">
            `;
            container.appendChild(div);
        });
    }

    function initSelectors() {
        // Render Cinema Buttons
        ['a_main', 'a_sup1', 'a_sup2'].forEach(prefix => {
            const container = document.getElementById(`cinema-${prefix}`);
            [1, 2, 4, 6].forEach(rank => {
                const btn = document.createElement('div');
                btn.className = 'rank-btn';
                btn.innerText = rank;
                btn.onclick = () => toggleCinema(prefix, rank);
                btn.id = `btn-${prefix}-c${rank}`;
                container.appendChild(btn);
            });
        });

        // Render Star Buttons
        ['w_main', 'w_sup1', 'w_sup2'].forEach(prefix => {
            const container = document.getElementById(`star-${prefix}`);
            [1, 2, 3, 4, 5].forEach(rank => {
                const btn = document.createElement('div');
                btn.className = 'rank-btn';
                btn.innerText = 'â˜…';
                if(rank === 1) btn.classList.add('active'); // Default 1 star
                btn.onclick = () => setStar(prefix, rank);
                btn.id = `btn-${prefix}-s${rank}`;
                container.appendChild(btn);
            });
        });
    }

    function initSetSelectors() {
        ['a_main', 'a_sup1', 'a_sup2'].forEach(prefix => {
            const sel = document.getElementById(`set4-${prefix}`);
            if(!sel) return;
            sel.innerHTML = '';
            for (const [key, val] of Object.entries(DISC_4_SETS)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = val.name;
                sel.appendChild(opt);
            }
        });
    }

    function initFileDropdowns() {
        const fill = (type, selectId) => {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- é€‰æ‹©é¢„è®¾ --</option>';
            if(REPO_FILES[type]) {
                REPO_FILES[type].forEach(file => {
                    const opt = document.createElement('option');
                    opt.value = file;
                    opt.text = file.replace('.json', '');
                    sel.appendChild(opt);
                });
            }
        };
        fill('dps', 'preset-dps-select');
        fill('sup', 'preset-sup1-select');
        fill('sup', 'preset-sup2-select');
        fill('wpDPS', 'preset-wdps-select');
        fill('wpSUP', 'preset-wsup1-select');
        fill('wpSUP', 'preset-wsup2-select');
    }

    window.onload = function() {
        createInputs('agent-main', 'a_main', agentFields);
        createInputs('agent-sup1', 'a_sup1', agentFields);
        createInputs('agent-sup2', 'a_sup2', agentFields);

        createInputs('weapon-main', 'w_main', weaponFields);
        createInputs('weapon-sup1', 'w_sup1', weaponFields);
        createInputs('weapon-sup2', 'w_sup2', weaponFields);

        initSelectors();
        initFileDropdowns();
        initSetSelectors();
        
        // Show Modal
        setTimeout(() => {
            document.getElementById('welcome-modal').classList.add('show');
        }, 100);

        calculateAll();
    };

    function closeModal() {
        document.getElementById('welcome-modal').classList.remove('show');
    }

    function setRes(val, btn) {
        // å¦‚æœå¤„äºå¼±ç‚¹çŠ¶æ€ï¼ŒæŠ—æ€§è¢«é”å®šä¸º0ï¼Œä¸å¯æ‰‹åŠ¨åˆ‡æ¢
        if(globalState.bossWeak) return;
        
        globalState.bossRes = val;
        
        // UIæ›´æ–°ï¼šç§»é™¤åŒç»„æŒ‰é’®æ¿€æ´»çŠ¶æ€ï¼Œæ¿€æ´»å½“å‰æŒ‰é’®
        const siblings = btn.parentElement.querySelectorAll('.zzz-btn');
        siblings.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        calculateAll();
    }

    function setWeakness(isWeak, btn) {
        globalState.bossWeak = isWeak;
        
        // UIæ›´æ–°ï¼šå¼±ç‚¹æŒ‰é’®ç»„
        const siblings = btn.parentElement.querySelectorAll('.zzz-btn');
        siblings.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // é€»è¾‘ï¼šå¦‚æœå¼±ç‚¹ä¸ºâ€œæ˜¯â€ï¼Œå¼ºåˆ¶é”å®šæŠ—æ€§ä¸º0%
        // è·å–æŠ—æ€§æŒ‰é’®ç»„ï¼ˆåœ¨ mod-boss ä¸‹çš„ç¬¬ä¸€ä¸ª switch-containerï¼‰
        const resContainer = document.querySelectorAll('#mod-boss .switch-container')[0];
        const resBtns = resContainer.querySelectorAll('.zzz-btn');
        
        if(isWeak) {
            // é”å®šçŠ¶æ€
            resBtns.forEach(b => {
                b.classList.remove('active');
                b.disabled = true;
                b.style.opacity = 0.5;
            });
            // è§†è§‰ä¸Šé€‰ä¸­ 0%
            resBtns[0].classList.add('active');
        } else {
            // è§£é”çŠ¶æ€
            resBtns.forEach(b => {
                b.disabled = false;
                b.style.opacity = 1;
                b.classList.remove('active');
            });
            // æ¢å¤ä¹‹å‰çš„æŠ—æ€§é€‰æ‹©
            if(globalState.bossRes === 0) resBtns[0].classList.add('active');
            else if(globalState.bossRes === 0.2) resBtns[1].classList.add('active');
            else if(globalState.bossRes === 0.4) resBtns[2].classList.add('active');
        }
        
        calculateAll();
    }
    // --- Logic: Cinema & Star Handling ---

    function toggleCinema(prefix, rank) {
        let current = globalState.configs[prefix].cinema;
        let newLevel = rank;
        
        if (current === rank) {
            // Toggle down logic: 6->4, 4->2, 2->1, 1->0
            if(rank===6) newLevel=4;
            else if(rank===4) newLevel=2;
            else if(rank===2) newLevel=1;
            else newLevel=0;
        }

        globalState.configs[prefix].cinema = newLevel;
        updateRankVisuals(prefix, 'cinema');
        repopulateInputs(prefix, 'agent');
    }

    function setStar(prefix, rank) {
        globalState.configs[prefix].star = rank;
        updateRankVisuals(prefix, 'star');
        repopulateInputs(prefix, 'weapon');
    }

    function updateRankVisuals(prefix, type) {
        if (type === 'cinema') {
            const level = globalState.configs[prefix].cinema;
            [1, 2, 4, 6].forEach(r => {
                const btn = document.getElementById(`btn-${prefix}-c${r}`);
                btn.classList.toggle('active', r <= level);
            });
        } else {
            const level = globalState.configs[prefix].star;
            [1, 2, 3, 4, 5].forEach(r => {
                const btn = document.getElementById(`btn-${prefix}-s${r}`);
                btn.classList.toggle('active', r <= level);
            });
        }
    }

    // --- Logic: Parsing Complex Values ---

    function parseAgentValue(valStr, cinemaLevel) {
        // Format: "Base/C1/C2/C4/C6" e.g. "19.4/0/10/0/0"
        if (typeof valStr === 'number') return valStr;
        if (!valStr.includes('/')) return parseFloat(valStr) || 0;

        const parts = valStr.split('/').map(s => parseFloat(s) || 0);
        let sum = parts[0]; // Base
        if (cinemaLevel >= 1 && parts.length > 1) sum += parts[1];
        if (cinemaLevel >= 2 && parts.length > 2) sum += parts[2];
        if (cinemaLevel >= 4 && parts.length > 3) sum += parts[3];
        if (cinemaLevel >= 6 && parts.length > 4) sum += parts[4];
        
        return sum;
    }

    function parseWeaponValue(valStr, starLevel) {
        // Format: "S1/S2/S3/S4/S5" e.g. "30/33/36/39/42"
        if (typeof valStr === 'number') return valStr;
        if (!valStr.includes('/')) return parseFloat(valStr) || 0;

        const parts = valStr.split('/').map(s => parseFloat(s) || 0);
        const idx = Math.max(0, Math.min(parts.length - 1, starLevel - 1));
        return parts[idx];
    }

    // --- File Loading & Input Population ---

    async function loadPreset(folder, prefix, filename) {
        if(!filename) return;
        const path = `./${folder}/${filename}`;
        try {
            const response = await fetch(path);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            globalState.rawPresets[prefix] = data;
            
            const type = (folder.includes('wp')) ? 'weapon' : 'agent';
            repopulateInputs(prefix, type);
            
        } catch (e) {
            alert(`æ— æ³•è¯»å–æ–‡ä»¶: ${path}\n${e.message}`);
        }
    }

    function repopulateInputs(prefix, type) {
        const data = globalState.rawPresets[prefix];
        if (!data) return;

        const fields = (type === 'weapon') ? weaponFields : agentFields;
        
        fields.forEach(f => {
            const rawVal = data[f.id]; 
            if (rawVal !== undefined) {
                let finalVal = 0;
                if (type === 'agent') {
                    finalVal = parseAgentValue(rawVal, globalState.configs[prefix].cinema);
                } else {
                    finalVal = parseWeaponValue(rawVal, globalState.configs[prefix].star);
                }
                
                const el = document.getElementById(`${prefix}_${f.id}`);
                if (el) el.value = finalVal;
            }
        });
        calculateAll();
    }

    // --- Helper: Safe Float ---
    function safeFloat(val) {
        if (val === undefined || val === null || val === '') return 0;
        const parsed = parseFloat(val);
        return isNaN(parsed) ? 0 : parsed;
    }

    function getVal(id) {
        const el = document.getElementById(id);
        return el ? safeFloat(el.value) : 0;
    }

    function getAgentData(prefix) {
        let data = {};
        // 1. Read Inputs
        agentFields.forEach(f => data[f.id] = getVal(`${prefix}_${f.id}`));
        data.atkPct = 0; // initialize atkPct since it's not a direct input

        // 2. Read & Apply 4-Set Stats
        const set4Select = document.getElementById(`set4-${prefix}`);
        if (set4Select) {
            const setKey = set4Select.value;
            const setInfo = DISC_4_SETS[setKey];
            if (setInfo && setInfo.stats) {
                // Merge stats. Note: we only map common stats. 
                // "inCombatAtkPct" is a specific field in agentFields.
                // "atkPct" (Out combat) goes to data.atkPct.
                // "dmgBonus", "critRate", "critDmg" match keys.
                for (const [sKey, sVal] of Object.entries(setInfo.stats)) {
                    if (data[sKey] !== undefined) {
                        data[sKey] += sVal;
                    } else if (sKey === 'atkPct') {
                        data.atkPct += sVal;
                    }
                }
            }
        }
        return data;
    }

    function getSet4Stats(prefix) {
        const set4Select = document.getElementById(`set4-${prefix}`);
        let stats = {};
        if (set4Select) {
            const setKey = set4Select.value;
            const setInfo = DISC_4_SETS[setKey];
            if (setInfo && setInfo.stats) {
                return setInfo.stats;
            }
        }
        return {};
    }

    function getWeaponData(prefix) {
        let data = {};
        weaponFields.forEach(f => data[f.id] = getVal(`${prefix}_${f.id}`));
        return data;
    }

    function getFieldBuffs() {
        return {
            inCombatAtkPct: getVal('field_inCombatAtkPct'),
            critRate: getVal('field_critRate'),
            critDmg: getVal('field_critDmg'),
            dmgBonus: getVal('field_dmgBonus'),
            resShred: getVal('field_resShred'),
            defShred: getVal('field_defShred'),
            dazeVuln: getVal('field_dazeVuln')
        };
    }

    // --- Core Calculation ---
    function calculateDamage(extraStats = {}) {
        let warnings = [];

        const aMain = getAgentData('a_main');
        const wMain = getWeaponData('w_main');
        const aSup1 = getAgentData('a_sup1');
        const aSup2 = getAgentData('a_sup2');
        const wSup1 = getWeaponData('w_sup1');
        const wSup2 = getWeaponData('w_sup2');
        const field = getFieldBuffs();
        
        // Retrieve 4-Set stats specifically to re-attribute them in breakdown
        // We only care about re-attributing the Main Agent's 4-set for now
        const set4Main = getSet4Stats('a_main');

        const sumSup = (key) => safeFloat(aSup1[key]) + safeFloat(aSup2[key]) + safeFloat(wSup1[key]) + safeFloat(wSup2[key]);

        const baseAtk = safeFloat(aMain.baseAtk) + safeFloat(wMain.baseAtk);
        if (baseAtk === 0) warnings.push("è­¦å‘Š: åŸºç¡€æ”»å‡»åŠ›(ç™½å€¼)ä¸º 0");

        const disc6_AtkPct = 30;
        const disc2_FlatAtk = 316;
        const slot4Type = document.getElementById('slot4-select').value;
        let disc4_AtkPct = slot4Type === 'atk' ? 30 : 0;
        let disc4_CR = slot4Type === 'critRate' ? 24 : 0;
        let disc4_CD = slot4Type === 'critDmg' ? 48 : 0;

        const extraAtkPct = safeFloat(extraStats.atkPct) + safeFloat(extraStats.slot5_AtkPct) + safeFloat(extraStats.set2_AtkPct);
        const extraCR = safeFloat(extraStats.critRate);
        const extraCD = safeFloat(extraStats.critDmg) + safeFloat(extraStats.set2_CD);
        const extraDmg = safeFloat(extraStats.dmgBonus) + safeFloat(extraStats.slot5_Dmg) + safeFloat(extraStats.set2_Dmg);
        const extraPenPct = safeFloat(extraStats.penRatio) + safeFloat(extraStats.slot5_Pen) + safeFloat(extraStats.set2_Pen);

        let outCombatAtkPct = 
            safeFloat(aMain.atkPct) + 
            safeFloat(wMain.atkPct) + 
            sumSup('atkPct') + 
            disc6_AtkPct + disc4_AtkPct + extraAtkPct;

        let outCombatFlatAtk = disc2_FlatAtk + safeFloat(extraStats.flatAtk);

        // Add Field Buffs
        let inCombatAtkPct = safeFloat(aMain.inCombatAtkPct) + safeFloat(wMain.inCombatAtkPct) + sumSup('inCombatAtkPct') + field.inCombatAtkPct;
        let inCombatFlatAtk = safeFloat(aMain.inCombatAtkFlat) + safeFloat(wMain.inCombatAtkFlat) + sumSup('inCombatAtkFlat');

        let sheetAtk = baseAtk * (1 + outCombatAtkPct/100) + outCombatFlatAtk;
        let totalAtk = sheetAtk * (1 + inCombatAtkPct/100) + inCombatFlatAtk;

        let totalCR = safeFloat(aMain.critRate) + safeFloat(wMain.critRate) + sumSup('critRate') + disc4_CR + extraCR + field.critRate;
        let totalCD = safeFloat(aMain.critDmg) + safeFloat(wMain.critDmg) + sumSup('critDmg') + disc4_CD + extraCD + field.critDmg;
        totalCR = Math.min(100, totalCR);
        // Formula: 1 + CR * CD
        let critMult = 1 + (totalCR/100) * (totalCD/100);

        let totalDmgBonus = safeFloat(aMain.dmgBonus) + safeFloat(wMain.dmgBonus) + sumSup('dmgBonus') + extraDmg + field.dmgBonus;
        let dmgMult = 1 + totalDmgBonus/100;

        let enemyRes = globalState.bossWeak ? 0 : globalState.bossRes;
        let weaknessVal = globalState.bossWeak ? 0.2 : 0;
        let totalResShred = safeFloat(aMain.resShred) + safeFloat(wMain.resShred) + sumSup('resShred') + field.resShred;
        let resMult = 1 - enemyRes + weaknessVal + (totalResShred/100);

        let baseDef = safeFloat(document.getElementById('boss-def-base').value);
        let defBonus = safeFloat(document.getElementById('boss-def-bonus').value);
        let totalDefShred = safeFloat(aMain.defShred) + safeFloat(wMain.defShred) + sumSup('defShred') + field.defShred;
        let totalPenPct = safeFloat(aMain.penRatio) + safeFloat(wMain.penRatio) + sumSup('penRatio') + extraPenPct;
        let totalPenVal = safeFloat(aMain.penValue) + safeFloat(wMain.penValue) + sumSup('penValue');

        let defCalced = baseDef * (1 + defBonus/100 - totalDefShred/100);
        let defRes = (defCalced * (1 - totalPenPct/100) - totalPenVal);
        let defMult = 794 / (defRes + 794);

        let totalDazeVuln = safeFloat(aMain.dazeVuln) + sumSup('dazeVuln') + field.dazeVuln;
        let dazeMult = 1 + totalDazeVuln/100;

        let skillMult = safeFloat(document.getElementById('skill-multiplier').value) / 100;
        
        let finalDmg = skillMult * totalAtk * dmgMult * critMult * resMult * defMult * dazeMult;

        return {
            dmg: finalDmg,
            warnings: warnings,
            details: {
                baseAtk, outCombatAtkPct, outCombatFlatAtk, sheetAtk, inCombatAtkPct, inCombatFlatAtk, totalAtk,
                totalCR, totalCD, totalDmgBonus, resMult, defMult, dazeMult, defRes,
                enemyRes, weaknessVal, totalResShred,
                baseDef, defBonus, totalDefShred, totalPenPct, totalPenVal,
                // Breakdown data for tooltips
                // Note: aMain.* includes the set 4 stats. We subtract them from 'a' and add them to 'disc'.
                breakdown: {
                    baseAtk: { a: safeFloat(aMain.baseAtk), w: safeFloat(wMain.baseAtk) },
                    outCombatAtkPct: { 
                        a: safeFloat(aMain.atkPct) - safeFloat(set4Main.atkPct || 0), 
                        w: safeFloat(wMain.atkPct), 
                        sup: sumSup('atkPct'),
                        disc: disc6_AtkPct + disc4_AtkPct + safeFloat(extraStats.atkPct) + safeFloat(extraStats.slot5_AtkPct) + safeFloat(extraStats.set2_AtkPct) + safeFloat(set4Main.atkPct || 0)
                    },
                    inCombatAtkPct: {
                        a: safeFloat(aMain.inCombatAtkPct) - safeFloat(set4Main.inCombatAtkPct || 0),
                        w: safeFloat(wMain.inCombatAtkPct),
                        sup: sumSup('inCombatAtkPct'),
                        field: field.inCombatAtkPct,
                        disc: safeFloat(set4Main.inCombatAtkPct || 0) // Attribute set 4 in-combat atk to Disc (conceptually) or just keep separate
                    },
                    inCombatFlatAtk: {
                        a: safeFloat(aMain.inCombatAtkFlat),
                        w: safeFloat(wMain.inCombatAtkFlat),
                        sup: sumSup('inCombatAtkFlat'),
                        disc: disc2_FlatAtk + safeFloat(extraStats.flatAtk)
                    },
                    totalCR: {
                        a: safeFloat(aMain.critRate) - safeFloat(set4Main.critRate || 0),
                        w: safeFloat(wMain.critRate),
                        sup: sumSup('critRate'),
                        disc: disc4_CR + extraCR + safeFloat(set4Main.critRate || 0),
                        field: field.critRate
                    },
                    totalCD: {
                        a: safeFloat(aMain.critDmg) - safeFloat(set4Main.critDmg || 0),
                        w: safeFloat(wMain.critDmg),
                        sup: sumSup('critDmg'),
                        disc: disc4_CD + extraCD + safeFloat(set4Main.critDmg || 0),
                        field: field.critDmg
                    },
                    dmgBonus: {
                        a: safeFloat(aMain.dmgBonus) - safeFloat(set4Main.dmgBonus || 0),
                        w: safeFloat(wMain.dmgBonus),
                        sup: sumSup('dmgBonus'),
                        disc: extraDmg + safeFloat(set4Main.dmgBonus || 0),
                        field: field.dmgBonus
                    },
                    resShred: {
                        a: safeFloat(aMain.resShred),
                        w: safeFloat(wMain.resShred),
                        sup: sumSup('resShred'),
                        field: field.resShred
                    },
                    defShred: {
                        a: safeFloat(aMain.defShred),
                        w: safeFloat(wMain.defShred),
                        sup: sumSup('defShred'),
                        field: field.defShred
                    },
                    penPct: {
                        a: safeFloat(aMain.penRatio),
                        w: safeFloat(wMain.penRatio),
                        sup: sumSup('penRatio'),
                        disc: extraPenPct
                    },
                    penVal: {
                        a: safeFloat(aMain.penValue),
                        w: safeFloat(wMain.penValue),
                        sup: sumSup('penValue')
                    }
                }
            }
        };
    }

    function calculateAll() {
        // æ ¸å¿ƒé€»è¾‘æ›´æ–°ï¼šæ— è®ºä½•ç§æ¨¡å¼ï¼Œéƒ½è¿è¡Œä¸€æ¬¡æœ€ä¼˜è®¡ç®—çš„æ•°æ®ç”Ÿæˆéƒ¨åˆ†ï¼Œ
        // ä»¥ä¾¿åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹è®¡ç®—â€œä¸æœ€ä¼˜é…ç½®çš„å·®è·â€ã€‚
        runOptimizationDataOnly();

        // å§‹ç»ˆæ›´æ–°æ‰‹åŠ¨æ¨¡å¼çš„é¢æ¿å’Œæ—¥å¿—ï¼Œç¡®ä¿æ•°æ®ä¸æ»å
        manualUpdate();

        // ä»…åœ¨è‡ªåŠ¨æ¨¡å¼å¼€å¯æ—¶æ›´æ–°å›¾è¡¨å’Œè‡ªåŠ¨æ¨¡å¼UI
        if(globalState.mode === 'auto') {
            let currentStepBtn = document.querySelector('.opt-controls button.active[id^="btn-"]');
            let steps = currentStepBtn ? parseInt(currentStepBtn.id.split('-')[1]) : 30;
            updateChartLine(steps);
        }
    }

    function renderPanel(containerId, d) {
        const el = document.getElementById(containerId);
        el.innerHTML = `
            <div class="panel-row"><span>æ€»æ”»å‡»åŠ›</span><span>${Math.floor(d.totalAtk)}</span></div>
            <div class="panel-row"><span>æš´å‡»ç‡</span><span>${d.totalCR.toFixed(1)}%</span></div>
            <div class="panel-row"><span>æš´å‡»ä¼¤å®³</span><span>${d.totalCD.toFixed(1)}%</span></div>
            <div class="panel-row"><span>å¢ä¼¤åŒº</span><span>${d.totalDmgBonus.toFixed(1)}%</span></div>
            <div class="panel-row"><span>ç©¿é€ç‡</span><span>${d.totalPenPct.toFixed(1)}%</span></div>
            <div class="panel-row"><span>ç©¿é€å€¼</span><span>${d.totalPenVal.toFixed(0)}</span></div>
            <div class="panel-row"><span>æ— è§†é˜²å¾¡(å‡é˜²)</span><span>${d.totalDefShred.toFixed(1)}%</span></div>
            <div class="panel-row"><span>å‡æŠ—</span><span>${d.totalResShred.toFixed(1)}%</span></div>
        `;
    }

    function manualUpdate() {
        let crCount = safeFloat(document.getElementById('sub-cr-count').value);
        let cdCount = safeFloat(document.getElementById('sub-cd-count').value);
        let atkCount = safeFloat(document.getElementById('sub-atk-count').value);
        
        let totalSubs = crCount + cdCount + atkCount;
        const warnEl = document.getElementById('sub-total-warn');
        if(totalSubs > 48) {
            warnEl.innerText = `è­¦å‘Š: è¯æ¡æ€»æ•° ${totalSubs} è¶…è¿‡ 48!`;
        } else {
            warnEl.innerText = `å½“å‰è¯æ¡æ•°: ${totalSubs} / 48`;
        }

        let slot5 = document.getElementById('slot5-select').value;
        let set2 = document.getElementById('set2-select').value;

        let extraStats = {
            critRate: crCount * 2.4,
            critDmg: cdCount * 4.8,
            atkPct: atkCount * 3.0,
            slot5_AtkPct: slot5 === 'atk' ? 30 : 0,
            slot5_Dmg: slot5 === 'dmg' ? 30 : 0,
            slot5_Pen: slot5 === 'pen' ? 24 : 0,
            set2_Dmg: set2 === 'dmg' ? 10 : 0,
            set2_Pen: set2 === 'pen' ? 8 : 0,
            set2_AtkPct: set2 === 'atk' ? 10 : 0,
            set2_CD: set2 === 'cd' ? 16 : 0
        };

        let result = calculateDamage(extraStats);

        // Gains
        let baseDmg = result.dmg;
        let safeDiv = (val) => baseDmg > 0 ? val : 0;

        let gainCR = safeDiv((calculateDamage({...extraStats, critRate: extraStats.critRate + 2.4}).dmg - baseDmg) / baseDmg * 100);
        let gainCD = safeDiv((calculateDamage({...extraStats, critDmg: extraStats.critDmg + 4.8}).dmg - baseDmg) / baseDmg * 100);
        let gainAtk = safeDiv((calculateDamage({...extraStats, atkPct: extraStats.atkPct + 3.0}).dmg - baseDmg) / baseDmg * 100);

        document.getElementById('gain-cr').innerText = `æ”¶ç›Š: +${gainCR.toFixed(2)}%`;
        document.getElementById('gain-cd').innerText = `æ”¶ç›Š: +${gainCD.toFixed(2)}%`;
        document.getElementById('gain-atk').innerText = `æ”¶ç›Š: +${gainAtk.toFixed(2)}%`;

        let noSlot5Stats = {...extraStats, slot5_AtkPct: 0, slot5_Dmg: 0, slot5_Pen: 0};
        let dmgNoSlot5 = calculateDamage(noSlot5Stats).dmg;
        let gainSlot5 = dmgNoSlot5 > 0 ? (baseDmg - dmgNoSlot5) / dmgNoSlot5 * 100 : 0;
        document.getElementById('gain-slot5').innerText = `å½“å‰é€‰æ‹©æ”¶ç›Š: +${gainSlot5.toFixed(2)}%`;

        let noSet2Stats = {...extraStats, set2_Dmg: 0, set2_Pen: 0, set2_AtkPct: 0, set2_CD: 0};
        let dmgNoSet2 = calculateDamage(noSet2Stats).dmg;
        let gainSet2 = dmgNoSet2 > 0 ? (baseDmg - dmgNoSet2) / dmgNoSet2 * 100 : 0;
        document.getElementById('gain-set2').innerText = `å½“å‰é€‰æ‹©æ”¶ç›Š: +${gainSet2.toFixed(2)}%`;

        displayLog(result);
        renderPanel('manual-panel', result.details);
        
        // Gap Calculation
        let optDmg = 0;
        if (globalState.allOptResults.length > 0) {
            // Find max damage for current step (totalSubs)
            let checkStep = Math.min(48, Math.max(0, totalSubs));
            globalState.allOptResults.forEach(res => {
                let stepData = res.history[checkStep];
                if(stepData && stepData.dmg > optDmg) optDmg = stepData.dmg;
            });
        }
        
        let gapStr = '';
        if (optDmg > 0 && baseDmg > 0) {
            let diff = (baseDmg - optDmg) / optDmg * 100;
            // å·®è·é€šå¸¸ä¸ºè´Ÿæ•°
            let color = diff > -1 ? 'var(--zzz-neon)' : 'var(--zzz-alert)';
            gapStr = `<br><span style="font-size:0.9rem; color:#888;">(ä¸${totalSubs}è¯æ¡æœ€ä¼˜è§£å·®è·: <span style="color:${color}">${diff.toFixed(2)}%</span>)</span>`;
        }

        const manualPanel = document.getElementById('manual-panel');
        manualPanel.innerHTML += `<div class="panel-row" style="color:var(--zzz-neon); font-weight:bold; margin-top:5px; border-top:1px solid #444; padding-top:5px; display:block; text-align:right;">
            <div style="display:flex; justify-content:space-between;"><span>æœ€ç»ˆä¼¤å®³</span><span>${Math.floor(result.dmg)}</span></div>
            ${gapStr}
        </div>`;
    }

    function displayLog(res) {
        let d = res.details;
        let b = d.breakdown;

        // Tooltip helper with Title - using HTML structure now
        // NOTE: We put all on one line or use template literals carefully to generate valid HTML string.
        const t = (val, title, content) => 
            `<span class="u-tooltip">${val}<span class="u-tooltip-content"><span class="u-tooltip-title">${title}</span>${content}</span></span>`;

        // Breakdown Strings
        const strBase = `ä»£ç†äºº: ${Math.floor(b.baseAtk.a)}\néŸ³æ“: ${Math.floor(b.baseAtk.w)}`;
        const strOutPct = `ä»£ç†äºº: ${b.outCombatAtkPct.a}%\néŸ³æ“: ${b.outCombatAtkPct.w}%\nè¾…åŠ©: ${b.outCombatAtkPct.sup}%\né©±åŠ¨ç›˜: ${b.outCombatAtkPct.disc}%`;
        const strInPct = `ä»£ç†äºº: ${b.inCombatAtkPct.a}%\néŸ³æ“: ${b.inCombatAtkPct.w}%\nè¾…åŠ©: ${b.inCombatAtkPct.sup}%\né©±åŠ¨ç›˜: ${b.inCombatAtkPct.disc || 0}%\nåœºåœ°: ${b.inCombatAtkPct.field}%`;
        const strInFlat = `ä»£ç†äºº: ${b.inCombatFlatAtk.a}\néŸ³æ“: ${b.inCombatFlatAtk.w}\nè¾…åŠ©: ${b.inCombatFlatAtk.sup}\né©±åŠ¨ç›˜: ${b.inCombatFlatAtk.disc}`;
        
        const strCR = `ä»£ç†äºº: ${b.totalCR.a}%\néŸ³æ“: ${b.totalCR.w}%\nè¾…åŠ©: ${b.totalCR.sup}%\né©±åŠ¨ç›˜: ${b.totalCR.disc}%\nåœºåœ°: ${b.totalCR.field}%`;
        const strCD = `ä»£ç†äºº: ${b.totalCD.a}%\néŸ³æ“: ${b.totalCD.w}%\nè¾…åŠ©: ${b.totalCD.sup}%\né©±åŠ¨ç›˜: ${b.totalCD.disc}%\nåœºåœ°: ${b.totalCD.field}%`;
        const strDmg = `ä»£ç†äºº: ${b.dmgBonus.a}%\néŸ³æ“: ${b.dmgBonus.w}%\nè¾…åŠ©: ${b.dmgBonus.sup}%\né©±åŠ¨ç›˜: ${b.dmgBonus.disc}%\nåœºåœ°: ${b.dmgBonus.field}%`;
        
        const strRes = `ä»£ç†äºº: ${b.resShred.a}%\néŸ³æ“: ${b.resShred.w}%\nè¾…åŠ©: ${b.resShred.sup}%\nåœºåœ°: ${b.resShred.field}%`;
        const strDefShred = `ä»£ç†äºº: ${b.defShred.a}%\néŸ³æ“: ${b.defShred.w}%\nè¾…åŠ©: ${b.defShred.sup}%\nåœºåœ°: ${b.defShred.field}%`;
        const strPen = `ç©¿é€ç‡(å’Œ): ${d.totalPenPct.toFixed(1)}%\nç©¿é€å€¼(å’Œ): ${d.totalPenVal.toFixed(0)}`;


        let log = `è®¡ç®—å…¬å¼ (åŸºäºæ‰‹åŠ¨æ¨¡å¼æ•°æ®)ï¼š
ä¼¤å®³ = æŠ€èƒ½å€ç‡ * ((ç™½å€¼*å±€å¤–% + å±€å¤–å›ºå®š) * (1+<span class="in-combat-highlight">å±€å†…%</span>) + <span class="in-combat-highlight">å±€å†…å›ºå®š</span>) * (1+å¢ä¼¤) * (1+æš´å‡»*çˆ†ä¼¤) * (1-æŠ—æ€§+å¼±ç‚¹+å‡æŠ—) * (794 / (((é˜²å¾¡*(1+åŠ æˆ-å‡é˜²))*(1-ç©¿é€ç‡)-ç©¿é€å€¼)+794)) * (1+å¤±è¡¡)

è¯¦ç»†æ•°å€¼ (é¼ æ ‡æ‚¬åœæŸ¥çœ‹æ¥æº)ï¼š
1. æ”»å‡»åŠ›åŒºï¼š
   å±€å¤– = (${t(d.baseAtk, 'åŸºç¡€æ”»å‡»åŠ›', strBase)} * (1+${t(d.outCombatAtkPct.toFixed(1)+'%', 'å±€å¤–æ”»å‡»%', strOutPct)}) + ${d.outCombatFlatAtk}) = ${Math.floor(d.sheetAtk)}
   å±€å†… = ${Math.floor(d.sheetAtk)} * (1+<span class="in-combat-highlight">${t(d.inCombatAtkPct.toFixed(1)+'%', 'å±€å†…æ”»å‡»%', strInPct)}</span>) + <span class="in-combat-highlight">${t(d.inCombatFlatAtk, 'å±€å†…å›ºå®šæ”»å‡»', strInFlat)}</span> = ${Math.floor(d.totalAtk)}

2. æš´å‡»åŒº (æœŸæœ›)ï¼š
   1 + (${t(d.totalCR.toFixed(1)+'%', 'æ€»æš´å‡»ç‡', strCR)} * ${t(d.totalCD.toFixed(1)+'%', 'æ€»æš´å‡»ä¼¤å®³', strCD)}) = ${(1 + (Math.min(d.totalCR,100)/100)*(d.totalCD/100)).toFixed(3)}

3. å¢ä¼¤åŒºï¼š
   1 + ${t(d.totalDmgBonus.toFixed(1)+'%', 'æ€»å¢ä¼¤', strDmg)} = ${((1+d.totalDmgBonus/100)).toFixed(3)}

4. æŠ—æ€§åŒºï¼š
   1 - ${d.enemyRes} (æŠ—æ€§) + ${d.weaknessVal} (å¼±ç‚¹) + ${t((d.totalResShred/100).toFixed(2), 'å‡æŠ—ç³»æ•°', strRes)} (å‡æŠ—) = ${d.resMult.toFixed(3)}

5. é˜²å¾¡åŒºï¼š
   é˜²å¾¡å€¼ = (${d.baseDef} * (1+${d.defBonus/100}-${t((d.totalDefShred/100).toFixed(2), 'é˜²å¾¡å‰Šå‡', strDefShred)})) * (1-${d.totalPenPct/100}) - ${d.totalPenVal} = ${t(d.defRes.toFixed(1), 'ç©¿é€è®¡ç®—', strPen)}
   ç³»æ•° = 794 / (${d.defRes.toFixed(1)} + 794) = ${d.defMult.toFixed(4)}

6. æœ€ç»ˆä¼¤å®³ï¼š
   ${Math.floor(res.dmg)}`;

        if (res.warnings.length > 0) {
            log += `\n\n<span class="alert-text">[å¼‚å¸¸å‘Šè­¦]:\n` + res.warnings.join('\n') + `</span>`;
        }
        document.getElementById('calc-log').innerHTML = log;
    }

    // --- Optimization Mode Logic ---
    function switchMode(mode) {
        globalState.mode = mode;
        document.getElementById('mode-manual-btn').classList.toggle('active', mode === 'manual');
        document.getElementById('mode-auto-btn').classList.toggle('active', mode === 'auto');
        document.getElementById('manual-ui').style.display = mode === 'manual' ? 'block' : 'none';
        document.getElementById('auto-ui').style.display = mode === 'auto' ? 'block' : 'none';

        calculateAll();
    }

    function runOptimizationDataOnly() {
        const slot5Opts = [
            {id: 'atk', val: {slot5_AtkPct: 30}, name: '5å·ä½:æ”»å‡»'},
            {id: 'dmg', val: {slot5_Dmg: 30}, name: '5å·ä½:å¢ä¼¤'},
            {id: 'pen', val: {slot5_Pen: 24}, name: '5å·ä½:ç©¿é€'}
        ];
        const set2Opts = [
            {id: 'atk', val: {set2_AtkPct: 10}, name: '2ä»¶å¥—:æ”»å‡»'},
            {id: 'dmg', val: {set2_Dmg: 10}, name: '2ä»¶å¥—:å¢ä¼¤'},
            {id: 'pen', val: {set2_Pen: 8}, name: '2ä»¶å¥—:ç©¿é€'},
            {id: 'cd', val: {set2_CD: 16}, name: '2ä»¶å¥—:çˆ†ä¼¤'}
        ];

        let allResults = [];

        // éå†æ‰€æœ‰å¯èƒ½çš„ç»„åˆ
        for(let s5 of slot5Opts) {
            for(let s2 of set2Opts) {
                let currentStats = {
                    critRate: 0, critDmg: 0, atkPct: 0,
                    ...s5.val, ...s2.val
                };
                let history = [];
                let currentDmg = calculateDamage(currentStats).dmg;
                let counts = { cr: 0, cd: 0, atk: 0 };

                // Step 0
                history.push({
                    step: 0, dmg: currentDmg,
                    stats: {...currentStats}, configName: `${s5.name} + ${s2.name}`,
                    gains: {cr: 0, cd: 0, atk: 0},
                    counts: {...counts}
                });

                // è´ªå¿ƒç®—æ³•æ¨¡æ‹Ÿè‡³48è¯æ¡
                for(let step=1; step<=48; step++) {
                    let dCR = calculateDamage({...currentStats, critRate: currentStats.critRate + 2.4}).dmg;
                    let dCD = calculateDamage({...currentStats, critDmg: currentStats.critDmg + 4.8}).dmg;
                    let dAtk = calculateDamage({...currentStats, atkPct: currentStats.atkPct + 3.0}).dmg;

                    let gCR = (dCR - currentDmg) / currentDmg * 100;
                    let gCD = (dCD - currentDmg) / currentDmg * 100;
                    let gAtk = (dAtk - currentDmg) / currentDmg * 100;

                    let bestMove = Math.max(dCR, dCD, dAtk);
                    
                    if(bestMove === dCR) { currentStats.critRate += 2.4; counts.cr++; }
                    else if(bestMove === dCD) { currentStats.critDmg += 4.8; counts.cd++; }
                    else { currentStats.atkPct += 3.0; counts.atk++; }

                    currentDmg = bestMove;
                    history.push({
                        step: step,
                        dmg: currentDmg,
                        stats: {...currentStats},
                        configName: `${s5.name} + ${s2.name}`,
                        gains: { cr: gCR, cd: gCD, atk: gAtk },
                        counts: {...counts}
                    });
                }
                
                // ä¿å­˜è¯¥ç»„åˆçš„å®Œæ•´å†å²
                allResults.push({
                    name: `${s5.name} + ${s2.name}`,
                    history: history
                });
            }
        }

        globalState.allOptResults = allResults;
    }
    
    // Alias to keep old logic if needed, but renamed to clarity
    function runOptimization() {
        runOptimizationDataOnly();
        let currentStepBtn = document.querySelector('.opt-controls button.active[id^="btn-"]');
        let steps = currentStepBtn ? parseInt(currentStepBtn.id.split('-')[1]) : 30;
        updateChartLine(steps);
    }

    // Chart Plugin for Vertical Line
    const verticalLinePlugin = {
        id: 'verticalLine',
        afterDatasetsDraw: (chart, args, options) => {
            if (chart.config._activeStep === undefined) return;
            const step = chart.config._activeStep;
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            
            const x = xAxis.getPixelForValue(step);
            
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(x, yAxis.top);
            ctx.lineTo(x, yAxis.bottom);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ffffff';
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.restore();
        }
    };

    function drawChart(history) {
        const ctx = document.getElementById('optChart').getContext('2d');
        if(globalState.chart) globalState.chart.destroy();

        // åŒ…å« step 0
        const chartData = history;
        const labels = chartData.map(h => h.step);
        
        const dataCR = chartData.map(h => h.gains.cr);
        const dataCD = chartData.map(h => h.gains.cd);
        const dataAtk = chartData.map(h => h.gains.atk);

        globalState.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'æš´å‡»ç‡æ”¶ç›Š', data: dataCR, borderColor: '#ff4d4d', borderWidth: 2, pointRadius: 1 },
                    { label: 'æš´å‡»ä¼¤å®³æ”¶ç›Š', data: dataCD, borderColor: '#dfff00', borderWidth: 2, pointRadius: 1 },
                    { label: 'æ”»å‡»åŠ›æ”¶ç›Š', data: dataAtk, borderColor: '#00ccff', borderWidth: 2, pointRadius: 1 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(3)}%`;
                            },
                            footer: function(tooltipItems) {
                                const idx = tooltipItems[0].dataIndex;
                                const h = chartData[idx];
                                return `æœ€ä¼˜åˆ†é…: CR:${h.counts.cr} CD:${h.counts.cd} Atk:${h.counts.atk}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        min: 0,
                        grid: { color: '#333' }, 
                        ticks: { color: '#888', stepSize: 3, maxTicksLimit: 20 }, 
                        title: {display:true, text:'æ­¥æ•°', color:'#666'} 
                    },
                    y: { 
                        grid: { color: '#333' }, 
                        ticks: { color: '#888' }, 
                        title: {display:true, text:'æ”¶ç›Šç‡ (%)', color:'#666'} 
                    }
                }
            },
            plugins: [verticalLinePlugin]
        });
    }

    function updateChartLine(steps) {
        ['30','36','42'].forEach(n => {
            document.getElementById(`btn-${n}`).classList.toggle('active', n == steps);
        });

        if(!globalState.allOptResults.length) return;

        // æ ¸å¿ƒé€»è¾‘ä¿®å¤ï¼šåœ¨æ‰€æœ‰æ–¹æ¡ˆä¸­ï¼Œå¯»æ‰¾åœ¨å½“å‰ steps æ­¥æ•°ä¸‹ä¼¤å®³æœ€é«˜çš„æ–¹æ¡ˆ
        let bestResult = null;
        let maxDmg = -1;

        globalState.allOptResults.forEach(res => {
            // è·å–è¯¥æ–¹æ¡ˆåœ¨ step å¤„çš„ä¼¤å®³
            let stepData = res.history[steps];
            if(stepData && stepData.dmg > maxDmg) {
                maxDmg = stepData.dmg;
                bestResult = res;
            }
        });

        if(!bestResult) return;

        globalState.optData = bestResult.history;
        let currentStepData = bestResult.history[steps];

        drawChart(bestResult.history);
        
        document.getElementById('opt-config-val').innerText = currentStepData.configName;
        document.getElementById('opt-sub-stats').innerText = 
            `æœ€ä¼˜åˆ†é…: æš´å‡»ç‡ ${currentStepData.counts.cr} | æš´å‡»ä¼¤å®³ ${currentStepData.counts.cd} | æ”»å‡»åŠ› ${currentStepData.counts.atk}`;

        // Update Panel
        renderPanel('opt-panel', calculateDamage(currentStepData.stats).details);
        document.getElementById('opt-dmg').innerText = Math.floor(currentStepData.dmg).toLocaleString();

        // Update Chart Line Position
        if (globalState.chart) {
            globalState.chart.config._activeStep = steps;
            globalState.chart.update(); 
        }
    }

    function exportSnapshot() {
        const btn = document.getElementById('export-btn');
        const originalText = btn.innerText;
        btn.innerText = "ğŸ“¸ ç”Ÿæˆä¸­...";
        btn.classList.add('active');

        setTimeout(() => {
            html2canvas(document.body, {
                useCORS: true,
                allowTaint: true,
                scrollY: -window.scrollY,
                windowWidth: document.documentElement.scrollWidth,
                windowHeight: document.documentElement.scrollHeight,
                backgroundColor: '#000000' // å¼ºåˆ¶èƒŒæ™¯è‰²ï¼Œé˜²æ­¢é€æ˜
            }).then(canvas => {
                const link = document.createElement('a');
                // ç”Ÿæˆæ–‡ä»¶åï¼šZZZ_Snapshot_YYYY-MM-DD.png
                const date = new Date().toISOString().slice(0, 10);
                link.download = `ZZZ_Snapshot_${date}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.innerText = originalText;
                btn.classList.remove('active');
            }).catch(err => {
                console.error(err);
                alert("å¯¼å‡ºå¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦æˆªå›¾åŠŸèƒ½ã€‚");
                btn.innerText = originalText;
                btn.classList.remove('active');
            });
        }, 100);
    }
</script>
</body>
</html>