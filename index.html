<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZZZç¥ç§˜å°ç®—ç›˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <!-- Hero Video Background -->
    <div class="video-background">
        <video id="hero-video" autoplay muted loop playsinline>
            <source
                src="https://act-webstatic.mihoyo.com/puzzle/zzz/pz_CynwWB0Her/resource/puzzle/2025/12/18/0f567d6a388a8a91870c700ac69cab83_4136800451326017658.mp4"
                type="video/mp4">
        </video>
    </div>

    <!-- Startup Modal -->
    <div id="welcome-modal" class="modal">
        <div class="modal-content">
            <h2>ä½¿ç”¨é¡»çŸ¥</h2>
            <p>
                æ¬¢è¿ä½¿ç”¨ ZZZç¥ç§˜å°ç®—ç›˜<br>
                æœ¬å·¥å…·ä»…ä¾›æ•°æ®æ¨¡æ‹Ÿä¸é…è£…å‚è€ƒã€‚<br>
                <br>
                tiPs<br>
                1. é€‰å–ä¸»Cä»£ç†äººå’Œè¾…åŠ©ä»£ç†äººï¼Œä»¥åŠä»–ä»¬çš„å½±ç”»ã€‚<br>
                2. é€‰å–ä»£ç†äººçš„éŸ³æ“ï¼Œä»¥åŠæ­¦å™¨çš„ç²¾ç‚¼ç­‰çº§ã€‚<br>
                3. æ‰‹åŠ¨è°ƒæ•´æ•Œäººæ•°æ®å’Œåœºåœ°BUFFã€‚<br>
                4. 4ä»¶å¥—å±æ€§ä¼šç›´æ¥åŠ ç®—è¿›è¯¥ä»£ç†äººçš„é¢æ¿ä¸­ã€‚<br>
                5. å¯¼å‡ºé…ç½®é•¿å›¾æ—¶ï¼Œç¡®ä¿é¡µé¢ç¼©æ”¾ä¸º100%ï¼ˆCtrl+0ï¼‰ã€‚<br>
                6. é©±åŠ¨ç›˜å’Œç­‰é»˜è®¤æ»¡è¦†ç›–ç‡ï¼Œè¯·ç»“åˆå®é™…è‡ªè¡Œåˆ¤æ–­ã€‚<br>
            </p>
            <button class="zzz-btn btn-large active" onclick="closeModal()">å¼€å§‹è®¡ç®—</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div class="container">
        <header>
            <h1>ZZZç¥ç§˜å°ç®—ç›˜</h1>

            <!-- Battle Type Toggle -->
            <div class="switch-container"
                style="display: inline-flex; margin-top: 15px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                <button class="zzz-btn active" id="type-attack" onclick="setBattleType('attack', this)">å¼ºæ”»</button>
                <button class="zzz-btn" id="type-break" onclick="setBattleType('break', this)">å‘½ç ´</button>
                <button class="zzz-btn" id="type-anomaly" onclick="setBattleType('anomaly', this)">å¼‚å¸¸</button>
            </div>
            <div class="credits">bY å¥¥ä¼¯å‹’æ–¯çš„åƒæ—©çˆ±éŸ³æœ¬äºº with Dr.Gemini</div>
            <div class="version">2026v0120</div>
        </header>

        <!-- Fixed Export Button (positioned via CSS) -->
        <button class="zzz-btn btn-large" id="export-btn" onclick="exportSnapshot()">
            ğŸ“¸ å¯¼å‡ºé…ç½®é•¿å›¾
        </button>

        <!-- Module 1: Agent Data -->
        <div class="module" id="mod-agent">
            <div class="module-title"><span>01 // ä»£ç†äººæ•°æ®</span></div>
            <div class="grid-3">
                <!-- Main DPS -->
                <!-- Main DPS -->
                <div class="sub-module" id="agent-main">
                    <h3>ä¸»Cä»£ç†äºº (DPS)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-dps-select" onchange="loadPreset('dps', 'a_main', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="cinema-a_main">
                                <!-- JS generates buttons -->
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>4ä»¶å¥—</label>
                        <select id="set4-a_main" onchange="updateSet4Display('a_main'); calculateAll()"></select>
                    </div>
                    <div id="set4-display-a_main"
                        style="font-size:0.85rem; color:var(--zzz-primary); padding:5px 0; min-height:20px;"></div>
                    <!-- Inputs generated by JS -->
                </div>
                <!-- Support 1 -->
                <div class="sub-module" id="agent-sup1">
                    <h3>è¾…åŠ© 1 (SUP)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-sup1-select" onchange="loadPreset('sup', 'a_sup1', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="cinema-a_sup1"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>4ä»¶å¥—</label>
                        <select id="set4-a_sup1" onchange="updateSet4Display('a_sup1'); calculateAll()"></select>
                    </div>
                    <div id="set4-display-a_sup1"
                        style="font-size:0.85rem; color:var(--zzz-primary); padding:5px 0; min-height:20px;"></div>
                </div>
                <!-- Support 2 -->
                <div class="sub-module" id="agent-sup2">
                    <h3>è¾…åŠ© 2 (SUP)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-sup2-select" onchange="loadPreset('sup', 'a_sup2', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="cinema-a_sup2"></div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>4ä»¶å¥—</label>
                        <select id="set4-a_sup2" onchange="updateSet4Display('a_sup2'); calculateAll()"></select>
                    </div>
                    <div id="set4-display-a_sup2"
                        style="font-size:0.85rem; color:var(--zzz-primary); padding:5px 0; min-height:20px;"></div>
                </div>
            </div>
        </div>

        <!-- Module 2: W-Engine Data -->
        <div class="module" id="mod-weapon">
            <div class="module-title"><span>02 // éŸ³æ“æ•°æ®</span></div>
            <div class="grid-3">
                <!-- Main Weapon -->
                <!-- Main Weapon -->
                <div class="sub-module" id="weapon-main">
                    <h3>ä¸»CéŸ³æ“ (wpDPS)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-wdps-select" onchange="loadPreset('wpDPS', 'w_main', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="star-w_main"></div>
                        </div>
                    </div>
                </div>
                <!-- Sup1 Weapon -->
                <div class="sub-module" id="weapon-sup1">
                    <h3>è¾…åŠ©1éŸ³æ“ (wpSUP)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-wsup1-select" onchange="loadPreset('wpSUP', 'w_sup1', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="star-w_sup1"></div>
                        </div>
                    </div>
                </div>
                <!-- Sup2 Weapon -->
                <div class="sub-module" id="weapon-sup2">
                    <h3>è¾…åŠ©2éŸ³æ“ (wpSUP)</h3>
                    <div class="preset-container">
                        <div class="preset-row">
                            <label>é¢„è®¾æ–‡ä»¶</label>
                            <select id="preset-wsup2-select" onchange="loadPreset('wpSUP', 'w_sup2', this.value)">
                                <option value="">-- åŠ è½½ä¸­... --</option>
                            </select>
                        </div>
                        <div class="rank-row">
                            <div class="rank-selector" id="star-w_sup2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module 3 & 4: Split Layout -->
        <div class="grid-2-split">
            <!-- Module 3: Disc Stats -->
            <div class="module" id="mod-preset-stats">
                <div class="module-title"><span>03 // é©±åŠ¨ç›˜ä¸»è¯æ¡</span></div>
                <div class="sub-module">
                    <div class="input-group break-hidden">
                        <label>6å·ä½ (å›ºå®š)</label>
                        <input type="text" value="30% æ”»å‡»åŠ›" disabled>
                    </div>
                    <div class="input-group default-hidden">
                        <label>6å·ä½ (å›ºå®š)</label>
                        <input type="text" value="30% ç”Ÿå‘½å€¼" disabled>
                    </div>
                    <div class="input-group break-hidden">
                        <label>2å·ä½ (å›ºå®š)</label>
                        <input type="text" value="316 å›ºå®šæ”»å‡»" disabled>
                    </div>
                    <div class="input-group default-hidden">
                        <label>2å·ä½ (å›ºå®š)</label>
                        <input type="text" value="2200 å›ºå®šç”Ÿå‘½" disabled>
                    </div>
                    <div class="input-group">
                        <label>4å·ä½ (å¯é€‰)</label>
                        <select id="slot4-select" onchange="calculateAll()">
                            <option value="critRate">24% æš´å‡»ç‡</option>
                            <option value="critDmg">48% æš´å‡»ä¼¤å®³</option>
                            <option value="atk">30% æ”»å‡»åŠ›</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Module 4: BOSS Data -->
            <div class="module" id="mod-boss">
                <div class="module-title"><span>04 // æ•Œäººæ•°æ®</span></div>
                <div class="sub-module">
                    <div class="input-group break-hidden">
                        <label>åŸºç¡€é˜²å¾¡åŠ›</label>
                        <select id="boss-def-base" onchange="calculateAll()">
                            <option value="953">é»˜è®¤ (953)</option>
                            <option value="1588">å½·å¾¨çŒæ‰‹ (1588)</option>
                            <option value="476">å¤ªåˆæ¢¦é­‡ (476)</option>
                        </select>
                    </div>
                    <div class="input-group break-hidden">
                        <label>é˜²å¾¡åŠ æˆ (%)</label>
                        <input type="number" id="boss-def-bonus" value="0" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label>åŸºç¡€å¤±è¡¡å€ç‡ (%)</label>
                        <input type="number" id="boss-daze-base" value="100" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label>æ•ŒäººæŠ—æ€§</label>
                        <div class="switch-container">
                            <button class="zzz-btn active" onclick="setRes(0, this)">0%</button>
                            <button class="zzz-btn" onclick="setRes(0.2, this)">20%</button>
                            <button class="zzz-btn" onclick="setRes(0.4, this)">40%</button>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top:10px;">
                        <label>æ•Œäººå¼±ç‚¹</label>
                        <div class="switch-container">
                            <button class="zzz-btn" onclick="setWeakness(true, this)">æ˜¯</button>
                            <button class="zzz-btn active" onclick="setWeakness(false, this)">å¦</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module 5: Optimization (Moved Up) -->
        <div class="module" id="mod-opt">
            <div class="module-title"><span>05 // è°ƒä¼˜ä¸æ¨¡æ‹Ÿ</span></div>

            <!-- Field Buffs (New) -->
            <div class="sub-module" style="margin-bottom: 20px; border-color: var(--zzz-primary);">
                <h3>åœºåœ°BUFF (å…¨å±€ç”Ÿæ•ˆ)</h3>
                <div class="grid-3">
                    <div class="input-group"><label>å±€å†…æ”»å‡»%</label><input type="number" id="field_inCombatAtkPct"
                            value="0" onchange="calculateAll()"></div>
                    <div class="input-group"><label>æš´å‡»ç‡%</label><input type="number" id="field_critRate" value="0"
                            onchange="calculateAll()"></div>
                    <div class="input-group"><label>æš´å‡»ä¼¤å®³%</label><input type="number" id="field_critDmg" value="0"
                            onchange="calculateAll()"></div>
                    <div class="input-group"><label>å¢ä¼¤%</label><input type="number" id="field_dmgBonus" value="0"
                            onchange="calculateAll()"></div>
                    <div class="input-group"><label>å‡æŠ—%</label><input type="number" id="field_resShred" value="0"
                            onchange="calculateAll()"></div>
                    <div class="input-group break-hidden"><label>æ— è§†é˜²å¾¡%</label><input type="number" id="field_defShred"
                            value="0" onchange="calculateAll()"></div>
                    <div class="input-group default-hidden"><label>ç”Ÿå‘½å€¼%</label><input type="number" id="field_hpPct"
                            value="0" onchange="calculateAll()"></div>
                    <div class="input-group default-hidden"><label>å±€å†…ç”Ÿå‘½%</label><input type="number"
                            id="field_inCombatHpPct" value="0" onchange="calculateAll()"></div>
                    <div class="input-group"><label>å¤±è¡¡æ˜“ä¼¤%</label><input type="number" id="field_dazeVuln" value="0"
                            onchange="calculateAll()"></div>
                </div>
            </div>

            <div class="opt-controls">
                <button class="zzz-btn btn-large active" id="mode-manual-btn"
                    onclick="switchMode('manual')">æ‰‹åŠ¨æ¨¡å¼</button>
                <button class="zzz-btn btn-large" id="mode-auto-btn" onclick="switchMode('auto')">æœ€ä¼˜è®¡ç®—</button>
            </div>

            <!-- Manual Mode UI -->
            <div id="manual-ui">
                <div class="grid-3">
                    <div class="sub-module">
                        <h3>å‰¯è¯æ¡æ•°é‡ (æ€»å’Œ â‰¤ 48)</h3>
                        <div class="input-group">
                            <label>æš´å‡»ç‡ (2.4%)</label>
                            <input type="number" id="sub-cr-count" value="0" min="0" onchange="calculateAll()">
                            <span id="gain-cr" style="color:var(--zzz-primary); font-size:0.8rem;"></span>
                        </div>
                        <div class="input-group">
                            <label>æš´å‡»ä¼¤å®³ (4.8%)</label>
                            <input type="number" id="sub-cd-count" value="0" min="0" onchange="calculateAll()">
                            <span id="gain-cd" style="color:var(--zzz-primary); font-size:0.8rem;"></span>
                        </div>
                        <div class="input-group break-hidden">
                            <label>æ”»å‡»åŠ› (3%)</label>
                            <input type="number" id="sub-atk-count" value="0" min="0" onchange="calculateAll()">
                            <span id="gain-atk" style="color:var(--zzz-primary); font-size:0.8rem;"></span>
                        </div>
                        <div class="input-group default-hidden">
                            <label>ç”Ÿå‘½å€¼ (3%)</label>
                            <input type="number" id="sub-hp-count" value="0" min="0" onchange="calculateAll()">
                            <span id="gain-hp" style="color:var(--zzz-primary); font-size:0.8rem;"></span>
                        </div>
                        <div style="text-align:right; color:var(--zzz-alert); font-size:0.8rem;" id="sub-total-warn">
                        </div>
                    </div>
                    <div class="sub-module">
                        <h3>è£…å¤‡é€‰æ‹©</h3>
                        <div class="input-group break-hidden">
                            <label>5å·ä½ä¸»è¯æ¡</label>
                            <select id="slot5-select" onchange="calculateAll()">
                                <option value="atk">30% æ”»å‡»åŠ›</option>
                                <option value="dmg">30% å¢ä¼¤</option>
                                <option value="pen">24% ç©¿é€ç‡</option>
                            </select>
                        </div>
                        <div class="input-group default-hidden">
                            <label>5å·ä½ä¸»è¯æ¡</label>
                            <select id="slot5-select-break" onchange="calculateAll()">
                                <option value="atk">30% æ”»å‡»åŠ›</option>
                                <option value="dmg">30% å¢ä¼¤</option>
                                <option value="hp">30% ç”Ÿå‘½å€¼</option>
                            </select>
                        </div>
                        <div style="text-align:right; font-size:0.8rem; color:var(--zzz-primary)" id="gain-slot5"></div>

                        <div class="input-group break-hidden">
                            <label>2ä»¶å¥—æ•ˆæœ</label>
                            <select id="set2-select" onchange="calculateAll()">
                                <option value="dmg">10% å¢ä¼¤</option>
                                <option value="pen">8% ç©¿é€ç‡</option>
                                <option value="atk">10% æ”»å‡»åŠ›</option>
                                <option value="cd">16% æš´å‡»ä¼¤å®³</option>
                            </select>
                        </div>
                        <div class="input-group default-hidden">
                            <label>2ä»¶å¥—æ•ˆæœ</label>
                            <select id="set2-select-break" onchange="calculateAll()">
                                <option value="dmg">10% å¢ä¼¤</option>
                                <option value="pen">8% ç©¿é€ç‡</option>
                                <option value="hp">10% ç”Ÿå‘½å€¼</option>
                                <option value="cd">16% æš´å‡»ä¼¤å®³</option>
                            </select>
                        </div>
                        <div style="text-align:right; font-size:0.8rem; color:var(--zzz-primary)" id="gain-set2"></div>
                    </div>
                    <div class="sub-module">
                        <h3>æœ€ç»ˆé¢æ¿ (æ‰‹åŠ¨)</h3>
                        <div id="manual-panel" class="panel-data"></div>
                    </div>
                </div>
            </div>

            <!-- Auto Mode UI -->
            <div id="auto-ui" style="display:none;">
                <div class="opt-controls">
                    <label style="color:#fff; margin-right:10px;">æŸ¥çœ‹èŠ‚ç‚¹ï¼š</label>
                    <button class="zzz-btn btn-large" id="btn-30" onclick="updateChartLine(30)">30è¯</button>
                    <button class="zzz-btn btn-large" id="btn-36" onclick="updateChartLine(36)">36è¯</button>
                    <button class="zzz-btn btn-large" id="btn-42" onclick="updateChartLine(42)">42è¯</button>
                </div>

                <!-- Existing Sub-stats Inputs -->
                <div class="sub-module" style="margin-bottom: 20px;">
                    <h3>å·²æœ‰å‰¯è¯æ¡ (å°†ä½œä¸ºè®¡ç®—èµ·ç‚¹)</h3>
                    <div class="grid-3">
                        <div class="input-group">
                            <label>æš´å‡»ç‡</label>
                            <input type="number" id="auto-cr-count" value="0" min="0" onchange="calculateAll()">
                        </div>
                        <div class="input-group">
                            <label>æš´å‡»ä¼¤å®³</label>
                            <input type="number" id="auto-cd-count" value="0" min="0" onchange="calculateAll()">
                        </div>
                        <div class="input-group break-hidden">
                            <label>æ”»å‡»åŠ›</label>
                            <input type="number" id="auto-atk-count" value="0" min="0" onchange="calculateAll()">
                        </div>
                        <div class="input-group default-hidden">
                            <label>ç”Ÿå‘½å€¼</label>
                            <input type="number" id="auto-hp-count" value="0" min="0" onchange="calculateAll()">
                        </div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="sub-module" style="grid-column: span 2;">
                        <div class="chart-wrapper">
                            <canvas id="optChart"></canvas>
                        </div>
                    </div>
                    <div class="sub-module">
                        <h3>æœ€ä¼˜é…è£…æ–¹æ¡ˆ</h3>
                        <div id="opt-config-display" class="opt-config-box">
                            <div class="opt-config-title">æ¨èæ­é…</div>
                            <div class="opt-config-val" id="opt-config-val">--</div>
                            <div class="opt-sub-stats" id="opt-sub-stats">--</div>
                        </div>

                        <h3>æœ€ç»ˆé¢æ¿ (æœ€ä¼˜)</h3>
                        <div id="opt-panel" class="panel-data">
                            <!-- Stats here -->
                        </div>

                        <h3 style="margin-top:20px;">ç†è®ºæé™ä¼¤å®³</h3>
                        <div id="opt-dmg"
                            style="font-size:2rem; color:var(--zzz-primary); text-align:right; text-shadow:0 0 10px var(--zzz-primary);">
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Module 6: Calculation Process (Moved Down) -->
        <div class="module" id="mod-calc">
            <div class="module-title"><span>06 // ä¼¤å®³è®¡ç®—æ ¸å¿ƒ</span></div>
            <div class="input-group" style="max-width: 300px;">
                <label>æŠ€èƒ½å€ç‡ (%)</label>
                <input type="number" id="skill-multiplier" value="100" onchange="calculateAll()">
            </div>
            <div class="calc-log" id="calc-log">
                ç­‰å¾…è®¡ç®—...
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION: FILE MANIFEST ---
        const REPO_FILES = {
            dps: ["å¶ç¬å…‰.json", "11å·â…¥.json", "é›¶å·å®‰æ¯”â…¥.json", "è‰¾è²Â·ä¹”â…¥.json", "ä¼ŠèŠ™ç³.json", "ä»ªç„.json", "æ‚ çœŸ.json"],
            sup: ["ç‰éŸ³.json", "ç…§.json", "è€€å˜‰éŸ³.json", "è±ç‰¹.json", "é’è¡£.json", "å¥¥è²æ–¯-è¾…åŠ©.json", "åƒå¤.json", "æ‰³æœº.json", "å¢è¥¿å¨….json"],
            wpDPS: ["äº‘éœ“å­¤å…‰.json", "ç¡«ç£ºçŸ³.json", "ç‰ºç‰²æ´çº¯.json", "æ·±æµ·è®¿å®¢.json", "å¿ƒå¼¦å¤œå“.json", "é’æºŸç¬¼èˆ.json", "æ®‹å¿ƒé’å›Š.json"],
            wpSUP: ["æ˜¨å¤œæ¥ç”µ.json", "åŠç³–é›ªå…”.json", "å¥½æ–—çš„é˜¿ç‚®.json", "ç²ç‘å¦†åŒ£.json", "ç„°å¿ƒæ¡‚å† .json", "ç‰å£¶é’å†°.json", "æ€ç»œæˆæ­Œ.json", "ç´¢é­‚å½±çœ¸.json", "é“¸æ¢¦ç‚‰æ­Œ.json"]
        };

        // --- DISC 4-SET DATA ---
        const DISC_4_SETS = {
            "none": { name: "-- æ— å¥—è£… --", stats: {} },
            "canglang": { name: "æ²§æµªè¡Œæ­Œ", stats: { dmgBonus: 10, critRate: 20, inCombatAtkPct: 10 } },
            "moon": { name: "æœˆå…‰éª‘å£«é¢‚", stats: { dmgBonus: 18 } },
            "mountain": { name: "å±±å¤§ç‹", stats: { critDmg: 30 } },
            "ruying": { name: "å¦‚å½±ç›¸éš", stats: { dmgBonus: 15, critRate: 12, inCombatAtkPct: 12 } },
            "jisu": { name: "æ¿€ç´ æœ‹å…‹", stats: { atkPct: 10, inCombatAtkPct: 25 } },
            "hetun": { name: "æ²³è±šç”µéŸ³", stats: { penRatio: 8, inCombatAtkPct: 15 } },
            "jiayin": { name: "é™å¬å˜‰éŸ³", stats: { dmgBonus: 24 } }
        };

        // --- Data Definitions ---
        const agentFields = [
            { id: 'baseAtk', label: 'åŸºç¡€æ”»å‡»', def: 0 },
            { id: 'critRate', label: 'æš´å‡»ç‡%', def: 0 },
            { id: 'critDmg', label: 'æš´å‡»ä¼¤å®³%', def: 0 },
            { id: 'dmgBonus', label: 'å¢ä¼¤%', def: 0 },
            { id: 'penRatio', label: 'ç©¿é€ç‡%', def: 0, cls: 'break-hidden' },
            { id: 'penValue', label: 'ç©¿é€å€¼', def: 0, cls: 'break-hidden' },
            { id: 'defShred', label: 'æ— è§†é˜²å¾¡(å‡é˜²)%', def: 0, cls: 'break-hidden' },
            { id: 'dazeVuln', label: 'å¤±è¡¡æ˜“ä¼¤%', def: 0 },
            { id: 'resShred', label: 'å‡æŠ—%', def: 0 },
            { id: 'inCombatAtkPct', label: 'å±€å†…æ”»å‡»%', def: 0 },
            { id: 'inCombatAtkFlat', label: 'å±€å†…å›ºå®šæ”»å‡»', def: 0 },
            // New Fields for Break Mode
            { id: 'baseHp', label: 'åŸºç¡€ç”Ÿå‘½', def: 0, cls: 'default-hidden' },
            { id: 'hpPct', label: 'ç”Ÿå‘½å€¼%', def: 0, cls: 'default-hidden' },
            { id: 'flatHp', label: 'å›ºå®šç”Ÿå‘½', def: 0, cls: 'default-hidden' },
            { id: 'inCombatHpPct', label: 'å±€å†…ç”Ÿå‘½%', def: 0, cls: 'default-hidden' },
            { id: 'inCombatPen', label: 'å±€å†…è´¯ç©¿åŠ›', def: 0, cls: 'default-hidden' },
            { id: 'ppDmgBonus', label: 'è´¯ç©¿å¢ä¼¤%', def: 0, cls: 'default-hidden' }
        ];

        const weaponFields = [
            { id: 'baseAtk', label: 'åŸºç¡€æ”»å‡»', def: 0 },
            { id: 'critRate', label: 'æš´å‡»ç‡%', def: 0 },
            { id: 'critDmg', label: 'æš´å‡»ä¼¤å®³%', def: 0 },
            { id: 'atkPct', label: 'æ”»å‡»åŠ›%', def: 0 },
            { id: 'penRatio', label: 'ç©¿é€ç‡%', def: 0, cls: 'break-hidden' },
            { id: 'defShred', label: 'æ— è§†é˜²å¾¡%', def: 0, cls: 'break-hidden' },
            { id: 'resShred', label: 'å‡æŠ—%', def: 0 },
            { id: 'dmgBonus', label: 'å¢ä¼¤%', def: 0 },
            { id: 'inCombatAtkPct', label: 'å±€å†…æ”»å‡»%', def: 0 },
            { id: 'inCombatAtkFlat', label: 'å±€å†…å›ºå®šæ”»å‡»', def: 0 },
            // New Fields
            { id: 'baseHp', label: 'åŸºç¡€ç”Ÿå‘½', def: 0, cls: 'default-hidden' },
            { id: 'hpPct', label: 'ç”Ÿå‘½å€¼%', def: 0, cls: 'default-hidden' },
            { id: 'flatHp', label: 'å›ºå®šç”Ÿå‘½', def: 0, cls: 'default-hidden' },
            { id: 'inCombatHpPct', label: 'å±€å†…ç”Ÿå‘½%', def: 0, cls: 'default-hidden' },
            { id: 'inCombatPen', label: 'å±€å†…è´¯ç©¿åŠ›', def: 0, cls: 'default-hidden' },
            { id: 'ppDmgBonus', label: 'è´¯ç©¿å¢ä¼¤%', def: 0, cls: 'default-hidden' }
        ];

        // --- Global State ---
        let globalState = {
            battleType: 'attack', // attack, break, anomaly
            bossRes: 0,
            bossWeak: false,
            mode: 'manual',
            chart: null,
            optData: [], // active display data
            allOptResults: [], // cache of all simulation combos
            rawPresets: {}, // Stores the raw JSON loaded from files
            configs: {
                a_main: { cinema: 0 },
                a_sup1: { cinema: 0 },
                a_sup2: { cinema: 0 },
                w_main: { star: 1 },
                w_sup1: { star: 1 },
                w_sup2: { star: 1 }
            }
        };

        function setBattleType(type, btn) {
            if (type === 'anomaly') {
                // Shake Animation
                const container = document.querySelector('.container');
                container.classList.add('shake-animation');

                // Remove class after animation to allow re-triggering
                setTimeout(() => {
                    container.classList.remove('shake-animation');
                }, 400);

                const attackBtn = document.getElementById('type-attack');
                setBattleType('attack', attackBtn);
                return;
            }

            globalState.battleType = type;
            document.body.setAttribute('data-mode', type);

            // UI Update
            const siblings = btn.parentElement.querySelectorAll('.zzz-btn');
            siblings.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Trigger calculation if needed (optional for now, but good practice)
            calculateAll();
        }

        // --- Initialization ---
        function createInputs(containerId, prefix, fields) {
            const container = document.getElementById(containerId);
            fields.forEach(f => {
                const div = document.createElement('div');
                div.className = `input-group ${f.cls || ''}`;
                div.innerHTML = `
                <label>${f.label}</label>
                <input type="number" id="${prefix}_${f.id}" value="${f.def}" onchange="calculateAll()">
            `;
                container.appendChild(div);
            });
        }

        function initSelectors() {
            // Render Cinema Buttons
            ['a_main', 'a_sup1', 'a_sup2'].forEach(prefix => {
                const container = document.getElementById(`cinema-${prefix}`);
                [1, 2, 4, 6].forEach(rank => {
                    const btn = document.createElement('div');
                    btn.className = 'rank-btn';
                    btn.innerText = rank;
                    btn.onclick = () => toggleCinema(prefix, rank);
                    btn.id = `btn-${prefix}-c${rank}`;
                    container.appendChild(btn);
                });
            });

            // Render Star Buttons
            ['w_main', 'w_sup1', 'w_sup2'].forEach(prefix => {
                const container = document.getElementById(`star-${prefix}`);
                [1, 2, 3, 4, 5].forEach(rank => {
                    const btn = document.createElement('div');
                    btn.className = 'rank-btn';
                    btn.innerText = 'â˜…';
                    if (rank === 1) btn.classList.add('active'); // Default 1 star
                    btn.onclick = () => setStar(prefix, rank);
                    btn.id = `btn-${prefix}-s${rank}`;
                    container.appendChild(btn);
                });
            });
        }

        function initSetSelectors() {
            ['a_main', 'a_sup1', 'a_sup2'].forEach(prefix => {
                const sel = document.getElementById(`set4-${prefix}`);
                if (!sel) return;
                sel.innerHTML = '';
                for (const [key, val] of Object.entries(DISC_4_SETS)) {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = val.name;
                    sel.appendChild(opt);
                }
                // Update display to show the default selection
                updateSet4Display(prefix);
            });
        }

        function updateSet4Display(prefix) {
            const sel = document.getElementById(`set4-${prefix}`);
            const displayDiv = document.getElementById(`set4-display-${prefix}`);
            if (!sel || !displayDiv) return;

            const setKey = sel.value;
            const setInfo = DISC_4_SETS[setKey];

            if (!setInfo || !setInfo.stats || Object.keys(setInfo.stats).length === 0) {
                displayDiv.innerHTML = '';
                return;
            }

            // Format stats for display
            const statsArray = [];
            const statsMap = {
                'dmgBonus': 'å¢ä¼¤',
                'critRate': 'æš´å‡»ç‡',
                'critDmg': 'æš´å‡»ä¼¤å®³',
                'inCombatAtkPct': 'å±€å†…æ”»å‡»',
                'atkPct': 'æ”»å‡»åŠ›',
                'penRatio': 'ç©¿é€ç‡',
                'hpPct': 'ç”Ÿå‘½å€¼',
                'inCombatHpPct': 'å±€å†…ç”Ÿå‘½'
            };

            for (const [key, value] of Object.entries(setInfo.stats)) {
                const label = statsMap[key] || key;
                statsArray.push(`${label}+${value}%`);
            }

            displayDiv.innerHTML = statsArray.join(' | ');
        }


        function initFileDropdowns() {
            const fill = (type, selectId) => {
                const sel = document.getElementById(selectId);
                sel.innerHTML = '<option value="">-- é€‰æ‹©é¢„è®¾ --</option>';
                if (REPO_FILES[type]) {
                    REPO_FILES[type].forEach(file => {
                        const opt = document.createElement('option');
                        opt.value = file;
                        opt.text = file.replace('.json', '');
                        sel.appendChild(opt);
                    });
                }
            };
            fill('dps', 'preset-dps-select');
            fill('sup', 'preset-sup1-select');
            fill('sup', 'preset-sup2-select');
            fill('wpDPS', 'preset-wdps-select');
            fill('wpSUP', 'preset-wsup1-select');
            fill('wpSUP', 'preset-wsup2-select');
        }

        window.onload = function () {
            createInputs('agent-main', 'a_main', agentFields);
            createInputs('agent-sup1', 'a_sup1', agentFields);
            createInputs('agent-sup2', 'a_sup2', agentFields);

            createInputs('weapon-main', 'w_main', weaponFields);
            createInputs('weapon-sup1', 'w_sup1', weaponFields);
            createInputs('weapon-sup2', 'w_sup2', weaponFields);

            initSelectors();
            initFileDropdowns();
            initSetSelectors();

            // Show Modal
            setTimeout(() => {
                document.getElementById('welcome-modal').classList.add('show');
            }, 100);

            calculateAll();
        };

        function closeModal() {
            document.getElementById('welcome-modal').classList.remove('show');
        }

        function setRes(val, btn) {
            // å¦‚æœå¤„äºå¼±ç‚¹çŠ¶æ€ï¼ŒæŠ—æ€§è¢«é”å®šä¸º0ï¼Œä¸å¯æ‰‹åŠ¨åˆ‡æ¢
            if (globalState.bossWeak) return;

            globalState.bossRes = val;

            // UIæ›´æ–°ï¼šç§»é™¤åŒç»„æŒ‰é’®æ¿€æ´»çŠ¶æ€ï¼Œæ¿€æ´»å½“å‰æŒ‰é’®
            const siblings = btn.parentElement.querySelectorAll('.zzz-btn');
            siblings.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            calculateAll();
        }

        function setWeakness(isWeak, btn) {
            globalState.bossWeak = isWeak;

            // UIæ›´æ–°ï¼šå¼±ç‚¹æŒ‰é’®ç»„
            const siblings = btn.parentElement.querySelectorAll('.zzz-btn');
            siblings.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // é€»è¾‘ï¼šå¦‚æœå¼±ç‚¹ä¸ºâ€œæ˜¯â€ï¼Œå¼ºåˆ¶é”å®šæŠ—æ€§ä¸º0%
            // è·å–æŠ—æ€§æŒ‰é’®ç»„ï¼ˆåœ¨ mod-boss ä¸‹çš„ç¬¬ä¸€ä¸ª switch-containerï¼‰
            const resContainer = document.querySelectorAll('#mod-boss .switch-container')[0];
            const resBtns = resContainer.querySelectorAll('.zzz-btn');

            if (isWeak) {
                // é”å®šçŠ¶æ€
                resBtns.forEach(b => {
                    b.classList.remove('active');
                    b.disabled = true;
                    b.style.opacity = 0.5;
                });
                // è§†è§‰ä¸Šé€‰ä¸­ 0%
                resBtns[0].classList.add('active');
            } else {
                // è§£é”çŠ¶æ€
                resBtns.forEach(b => {
                    b.disabled = false;
                    b.style.opacity = 1;
                    b.classList.remove('active');
                });
                // æ¢å¤ä¹‹å‰çš„æŠ—æ€§é€‰æ‹©
                if (globalState.bossRes === 0) resBtns[0].classList.add('active');
                else if (globalState.bossRes === 0.2) resBtns[1].classList.add('active');
                else if (globalState.bossRes === 0.4) resBtns[2].classList.add('active');
            }

            calculateAll();
        }
        // --- Logic: Cinema & Star Handling ---

        function toggleCinema(prefix, rank) {
            let current = globalState.configs[prefix].cinema;
            let newLevel = rank;

            if (current === rank) {
                // Toggle down logic: 6->4, 4->2, 2->1, 1->0
                if (rank === 6) newLevel = 4;
                else if (rank === 4) newLevel = 2;
                else if (rank === 2) newLevel = 1;
                else newLevel = 0;
            }

            globalState.configs[prefix].cinema = newLevel;
            updateRankVisuals(prefix, 'cinema');
            repopulateInputs(prefix, 'agent');
        }

        function setStar(prefix, rank) {
            globalState.configs[prefix].star = rank;
            updateRankVisuals(prefix, 'star');
            repopulateInputs(prefix, 'weapon');
        }

        function updateRankVisuals(prefix, type) {
            if (type === 'cinema') {
                const level = globalState.configs[prefix].cinema;
                [1, 2, 4, 6].forEach(r => {
                    const btn = document.getElementById(`btn-${prefix}-c${r}`);
                    btn.classList.toggle('active', r <= level);
                });
            } else {
                const level = globalState.configs[prefix].star;
                [1, 2, 3, 4, 5].forEach(r => {
                    const btn = document.getElementById(`btn-${prefix}-s${r}`);
                    btn.classList.toggle('active', r <= level);
                });
            }
        }

        // --- Logic: Parsing Complex Values ---

        function parseAgentValue(valStr, cinemaLevel) {
            // Format: "Base/C1/C2/C4/C6" e.g. "19.4/0/10/0/0"
            if (typeof valStr === 'number') return valStr;
            if (!valStr.includes('/')) return parseFloat(valStr) || 0;

            const parts = valStr.split('/').map(s => parseFloat(s) || 0);
            let sum = parts[0]; // Base
            if (cinemaLevel >= 1 && parts.length > 1) sum += parts[1];
            if (cinemaLevel >= 2 && parts.length > 2) sum += parts[2];
            if (cinemaLevel >= 4 && parts.length > 3) sum += parts[3];
            if (cinemaLevel >= 6 && parts.length > 4) sum += parts[4];

            return sum;
        }

        function parseWeaponValue(valStr, starLevel) {
            // Format: "S1/S2/S3/S4/S5" e.g. "30/33/36/39/42"
            if (typeof valStr === 'number') return valStr;
            if (!valStr.includes('/')) return parseFloat(valStr) || 0;

            const parts = valStr.split('/').map(s => parseFloat(s) || 0);
            const idx = Math.max(0, Math.min(parts.length - 1, starLevel - 1));
            return parts[idx];
        }

        // --- File Loading & Input Population ---

        async function loadPreset(folder, prefix, filename) {
            // If user selects "-- é€‰æ‹©é¢„è®¾ --" (empty filename), reset all inputs to 0
            if (!filename) {
                const type = (folder.includes('wp')) ? 'weapon' : 'agent';
                const fields = (type === 'weapon') ? weaponFields : agentFields;

                // Reset all input fields to 0
                fields.forEach(f => {
                    const el = document.getElementById(`${prefix}_${f.id}`);
                    if (el) el.value = 0;
                });

                // Clear the preset data from global state
                delete globalState.rawPresets[prefix];

                // Recalculate
                calculateAll();
                return;
            }

            const path = `./${folder}/${filename}`;
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                globalState.rawPresets[prefix] = data;

                const type = (folder.includes('wp')) ? 'weapon' : 'agent';
                repopulateInputs(prefix, type);

                // Special Rule Toast
                if (folder === 'dps' && filename === 'é›¶å·å®‰æ¯”â…¥.json') {
                    showToast("å·²è®¡ç®—30%æš´ä¼¤è‡ªæ‹");
                }

            } catch (e) {
                alert(`æ— æ³•è¯»å–æ–‡ä»¶: ${path}\n${e.message}`);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => {
                t.classList.remove('show');
            }, 3000);
        }

        function repopulateInputs(prefix, type) {
            const data = globalState.rawPresets[prefix];
            if (!data) return;

            const fields = (type === 'weapon') ? weaponFields : agentFields;

            fields.forEach(f => {
                const rawVal = data[f.id];
                if (rawVal !== undefined) {
                    let finalVal = 0;
                    if (type === 'agent') {
                        finalVal = parseAgentValue(rawVal, globalState.configs[prefix].cinema);
                    } else {
                        finalVal = parseWeaponValue(rawVal, globalState.configs[prefix].star);
                    }

                    const el = document.getElementById(`${prefix}_${f.id}`);
                    if (el) el.value = finalVal;
                }
            });
            calculateAll();
        }

        // --- Helper: Safe Float ---
        function safeFloat(val) {
            if (val === undefined || val === null || val === '') return 0;
            const parsed = parseFloat(val);
            return isNaN(parsed) ? 0 : parsed;
        }

        function getVal(id) {
            const el = document.getElementById(id);
            return el ? safeFloat(el.value) : 0;
        }

        function getAgentData(prefix) {
            let data = {};
            // 1. Read Inputs
            agentFields.forEach(f => data[f.id] = getVal(`${prefix}_${f.id}`));
            data.atkPct = 0; // initialize atkPct since it's not a direct input

            // 2. Read & Apply 4-Set Stats
            const set4Select = document.getElementById(`set4-${prefix}`);
            if (set4Select) {
                const setKey = set4Select.value;
                const setInfo = DISC_4_SETS[setKey];
                if (setInfo && setInfo.stats) {
                    // Merge stats. Note: we only map common stats. 
                    // "inCombatAtkPct" is a specific field in agentFields.
                    // "atkPct" (Out combat) goes to data.atkPct.
                    // "dmgBonus", "critRate", "critDmg" match keys.
                    for (const [sKey, sVal] of Object.entries(setInfo.stats)) {
                        if (data[sKey] !== undefined) {
                            data[sKey] += sVal;
                        } else if (sKey === 'atkPct') {
                            data.atkPct += sVal;
                        }
                    }
                }
            }
            return data;
        }

        function getSet4Stats(prefix) {
            const set4Select = document.getElementById(`set4-${prefix}`);
            let stats = {};
            if (set4Select) {
                const setKey = set4Select.value;
                const setInfo = DISC_4_SETS[setKey];
                if (setInfo && setInfo.stats) {
                    return setInfo.stats;
                }
            }
            return {};
        }

        function getWeaponData(prefix) {
            let data = {};
            weaponFields.forEach(f => data[f.id] = getVal(`${prefix}_${f.id}`));
            return data;
        }

        function getFieldBuffs() {
            return {
                inCombatAtkPct: getVal('field_inCombatAtkPct'),
                critRate: getVal('field_critRate'),
                critDmg: getVal('field_critDmg'),
                dmgBonus: getVal('field_dmgBonus'),
                resShred: getVal('field_resShred'),
                defShred: getVal('field_defShred'),
                dazeVuln: getVal('field_dazeVuln'),
                // New Fields
                hpPct: getVal('field_hpPct'),
                inCombatHpPct: getVal('field_inCombatHpPct')
            };
        }

        // --- Core Calculation ---
        function calculateDamage(extraStats = {}) {
            let warnings = [];

            const aMain = getAgentData('a_main');
            const wMain = getWeaponData('w_main');
            const aSup1 = getAgentData('a_sup1');
            const aSup2 = getAgentData('a_sup2');
            const wSup1 = getWeaponData('w_sup1');
            const wSup2 = getWeaponData('w_sup2');
            const field = getFieldBuffs();

            // Retrieve 4-Set stats specifically to re-attribute them in breakdown
            // We only care about re-attributing the Main Agent's 4-set for now
            const set4Main = getSet4Stats('a_main');

            const sumSup = (key) => safeFloat(aSup1[key]) + safeFloat(aSup2[key]) + safeFloat(wSup1[key]) + safeFloat(wSup2[key]);

            const baseAtk = safeFloat(aMain.baseAtk) + safeFloat(wMain.baseAtk);
            if (baseAtk === 0) warnings.push("è­¦å‘Š: åŸºç¡€æ”»å‡»åŠ›(ç™½å€¼)ä¸º 0");

            const disc6_AtkPct = 30;
            const disc2_FlatAtk = 316;
            const slot4Type = document.getElementById('slot4-select').value;
            let disc4_AtkPct = slot4Type === 'atk' ? 30 : 0;
            let disc4_CR = slot4Type === 'critRate' ? 24 : 0;
            let disc4_CD = slot4Type === 'critDmg' ? 48 : 0;

            const extraAtkPct = safeFloat(extraStats.atkPct) + safeFloat(extraStats.slot5_AtkPct) + safeFloat(extraStats.set2_AtkPct);
            const extraHpPct = safeFloat(extraStats.hpPct) + safeFloat(extraStats.slot5_HpPct) + safeFloat(extraStats.set2_HpPct);
            const extraCR = safeFloat(extraStats.critRate);
            const extraCD = safeFloat(extraStats.critDmg) + safeFloat(extraStats.set2_CD);
            const extraDmg = safeFloat(extraStats.dmgBonus) + safeFloat(extraStats.slot5_Dmg) + safeFloat(extraStats.set2_Dmg);
            const extraPenPct = safeFloat(extraStats.penRatio) + safeFloat(extraStats.slot5_Pen) + safeFloat(extraStats.set2_Pen);

            let outCombatAtkPct =
                safeFloat(aMain.atkPct) +
                safeFloat(wMain.atkPct) +
                sumSup('atkPct') +
                disc6_AtkPct + disc4_AtkPct + extraAtkPct;

            let outCombatFlatAtk = disc2_FlatAtk + safeFloat(extraStats.flatAtk);

            // Add Field Buffs
            let inCombatAtkPct = safeFloat(aMain.inCombatAtkPct) + safeFloat(wMain.inCombatAtkPct) + sumSup('inCombatAtkPct') + field.inCombatAtkPct;
            let inCombatFlatAtk = safeFloat(aMain.inCombatAtkFlat) + safeFloat(wMain.inCombatAtkFlat) + sumSup('inCombatAtkFlat');

            let sheetAtk = baseAtk * (1 + outCombatAtkPct / 100) + outCombatFlatAtk;
            let totalAtk = sheetAtk * (1 + inCombatAtkPct / 100) + inCombatFlatAtk;

            // --- Break Mode Logic (Pierce Calculation) ---
            let totalPierce = 0;
            if (globalState.battleType === 'break') {
                const disc6_HpPct = 30;
                const disc2_FlatHp = 2200;

                const baseHp = safeFloat(aMain.baseHp) + safeFloat(wMain.baseHp);
                // Include extraHpPct from sub-stats and equipment choices
                const outHpPct = safeFloat(aMain.hpPct) + safeFloat(wMain.hpPct) + sumSup('hpPct') + disc6_HpPct + extraHpPct;
                const outFlatHp = safeFloat(aMain.flatHp) + safeFloat(wMain.flatHp) + sumSup('flatHp') + disc2_FlatHp;
                const inCombatHpPct = safeFloat(aMain.inCombatHpPct) + safeFloat(wMain.inCombatHpPct) + sumSup('inCombatHpPct');
                const inCombatPen = safeFloat(aMain.inCombatPen) + safeFloat(wMain.inCombatPen) + sumSup('inCombatPen');

                // Base Pierce (Sum of penValue)
                const basePierce = safeFloat(aMain.penValue) + safeFloat(wMain.penValue) + sumSup('penValue');

                // Formula: "è´¯ç©¿åŠ›" = "åŸºç¡€è´¯ç©¿åŠ›" + (0.1 * ("åŸºç¡€ç”Ÿå‘½å€¼" * "å±€å¤–ç”Ÿå‘½å€¼ç™¾åˆ†æ¯”" + "å±€å¤–å›ºå®šç”Ÿå‘½å€¼") * (1 + "å±€å†…ç”Ÿå‘½å€¼ç™¾åˆ†æ¯”")) + (0.3 * (("æ”»å‡»åŠ›ç™½å€¼" * "å±€å¤–æ”»å‡»åŠ›ç™¾åˆ†æ¯”" + "å±€å¤–å›ºå®šæ”»å‡»åŠ›") * (1 + "å±€å†…æ”»å‡»åŠ›ç™¾åˆ†æ¯”") + "å±€å†…å›ºå®šæ”»å‡»åŠ›")) + "å±€å†…è´¯ç©¿åŠ›"
                // Term 1: HP Part
                const hpTerm = 0.1 * (baseHp * (1 + outHpPct / 100) + outFlatHp) * (1 + inCombatHpPct / 100);

                // Term 2: Atk Part (Use calculated Total Atk structure)
                // Note: The formula says: (("æ”»å‡»åŠ›ç™½å€¼" * "å±€å¤–æ”»å‡»åŠ›ç™¾åˆ†æ¯”" + "å±€å¤–å›ºå®šæ”»å‡»åŠ›") * (1 + "å±€å†…æ”»å‡»åŠ›ç™¾åˆ†æ¯”") + "å±€å†…å›ºå®šæ”»å‡»åŠ›")
                // This is EXACTLY our `totalAtk` variable.
                const atkTerm = 0.3 * totalAtk;

                totalPierce = basePierce + hpTerm + atkTerm + inCombatPen;
            }


            let totalCR = safeFloat(aMain.critRate) + safeFloat(wMain.critRate) + sumSup('critRate') + disc4_CR + extraCR + field.critRate;
            let totalCD = safeFloat(aMain.critDmg) + safeFloat(wMain.critDmg) + sumSup('critDmg') + disc4_CD + extraCD + field.critDmg;

            // Special Rule: Anby Zero VI
            const dpsSelect = document.getElementById('preset-dps-select');
            if (dpsSelect && dpsSelect.value === 'é›¶å·å®‰æ¯”â…¥.json') {
                totalCD = totalCD * 1.3;
            }

            totalCR = Math.min(100, totalCR);
            // Formula: 1 + CR * CD
            let critMult = 1 + (totalCR / 100) * (totalCD / 100);

            let totalDmgBonus = safeFloat(aMain.dmgBonus) + safeFloat(wMain.dmgBonus) + sumSup('dmgBonus') + extraDmg + field.dmgBonus;
            let dmgMult = 1 + totalDmgBonus / 100;

            let enemyRes = globalState.bossWeak ? 0 : globalState.bossRes;
            let weaknessVal = globalState.bossWeak ? 0.2 : 0;
            let totalResShred = safeFloat(aMain.resShred) + safeFloat(wMain.resShred) + sumSup('resShred') + field.resShred;
            let resMult = 1 - enemyRes + weaknessVal + (totalResShred / 100);

            let baseDef = safeFloat(document.getElementById('boss-def-base').value);
            let defBonus = safeFloat(document.getElementById('boss-def-bonus').value);
            let totalDefShred = safeFloat(aMain.defShred) + safeFloat(wMain.defShred) + sumSup('defShred') + field.defShred;
            let totalPenPct = safeFloat(aMain.penRatio) + safeFloat(wMain.penRatio) + sumSup('penRatio') + extraPenPct;
            let totalPenVal = safeFloat(aMain.penValue) + safeFloat(wMain.penValue) + sumSup('penValue');

            let defCalced = baseDef * (1 + defBonus / 100 - totalDefShred / 100);
            let defRes = (defCalced * (1 - totalPenPct / 100) - totalPenVal);
            let defMult = 794 / (defRes + 794);

            // Break Mode: Bypass Defense
            if (globalState.battleType === 'break') {
                defMult = 1;
                defRes = 0; // For display purposes
            }

            let totalDazeVuln = safeFloat(aMain.dazeVuln) + sumSup('dazeVuln') + field.dazeVuln;
            let baseDaze = safeFloat(document.getElementById('boss-daze-base').value);
            let dazeMult = (baseDaze + totalDazeVuln) / 100;

            let skillMult = safeFloat(document.getElementById('skill-multiplier').value) / 100;

            // Final Damage Calculation
            let finalDmg;
            if (globalState.battleType === 'break') {
                // Break Mode Formula: ä¼¤å®³ = æŠ€èƒ½å€ç‡ * è´¯ç©¿åŠ› * (1 + å¢ä¼¤) * (1 + æš´å‡»ç‡ * æš´å‡»ä¼¤å®³) * (1 - æŠ—æ€§ + å¼±ç‚¹ + å‡æŠ—) * ((åŸºç¡€å¤±è¡¡ + å¤±è¡¡æ˜“ä¼¤) / 100) * (1 + è´¯ç©¿å¢ä¼¤)
                let totalPPDmgBonus = safeFloat(aMain.ppDmgBonus) + safeFloat(wMain.ppDmgBonus) + sumSup('ppDmgBonus');
                finalDmg = skillMult * totalPierce * dmgMult * critMult * resMult * dazeMult * (1 + totalPPDmgBonus / 100);
            } else {
                // Attack Mode Formula: Uses defense multiplier
                finalDmg = skillMult * totalAtk * dmgMult * critMult * resMult * defMult * dazeMult;
            }

            return {
                dmg: finalDmg,
                warnings: warnings,
                details: {
                    baseAtk, outCombatAtkPct, outCombatFlatAtk, sheetAtk, inCombatAtkPct, inCombatFlatAtk, totalAtk,
                    totalPierce, // Added for Break Mode
                    maxHpInCombat: (globalState.battleType === 'break' ?
                        ((safeFloat(aMain.baseHp) + safeFloat(wMain.baseHp)) * (1 + (safeFloat(aMain.hpPct) + safeFloat(wMain.hpPct) + sumSup('hpPct') + 30 + extraHpPct) / 100) + (safeFloat(aMain.flatHp) + safeFloat(wMain.flatHp) + sumSup('flatHp') + 2200)) * (1 + (safeFloat(aMain.inCombatHpPct) + safeFloat(wMain.inCombatHpPct) + sumSup('inCombatHpPct')) / 100)
                        : 0),
                    totalCR, totalCD, totalDmgBonus, resMult, defMult, dazeMult, defRes,
                    enemyRes, weaknessVal, totalResShred, totalDazeVuln, baseDaze,
                    baseDef, defBonus, totalDefShred, totalPenPct, totalPenVal,
                    // Breakdown data for tooltips
                    // Note: aMain.* includes the set 4 stats. We subtract them from 'a' and add them to 'disc'.
                    breakdown: {
                        baseAtk: { a: safeFloat(aMain.baseAtk), w: safeFloat(wMain.baseAtk) },
                        outCombatAtkPct: {
                            a: safeFloat(aMain.atkPct) - safeFloat(set4Main.atkPct || 0),
                            w: safeFloat(wMain.atkPct),
                            sup: sumSup('atkPct'),
                            disc: disc6_AtkPct + disc4_AtkPct + safeFloat(extraStats.atkPct) + safeFloat(extraStats.slot5_AtkPct) + safeFloat(extraStats.set2_AtkPct) + safeFloat(set4Main.atkPct || 0)
                        },
                        inCombatAtkPct: {
                            a: safeFloat(aMain.inCombatAtkPct) - safeFloat(set4Main.inCombatAtkPct || 0),
                            w: safeFloat(wMain.inCombatAtkPct),
                            sup: sumSup('inCombatAtkPct'),
                            field: field.inCombatAtkPct,
                            disc: safeFloat(set4Main.inCombatAtkPct || 0) // Attribute set 4 in-combat atk to Disc (conceptually) or just keep separate
                        },
                        inCombatFlatAtk: {
                            a: safeFloat(aMain.inCombatAtkFlat),
                            w: safeFloat(wMain.inCombatAtkFlat),
                            sup: sumSup('inCombatAtkFlat'),
                            disc: disc2_FlatAtk + safeFloat(extraStats.flatAtk)
                        },
                        totalCR: {
                            a: safeFloat(aMain.critRate) - safeFloat(set4Main.critRate || 0),
                            w: safeFloat(wMain.critRate),
                            sup: sumSup('critRate'),
                            disc: disc4_CR + extraCR + safeFloat(set4Main.critRate || 0),
                            field: field.critRate
                        },
                        totalCD: {
                            a: safeFloat(aMain.critDmg) - safeFloat(set4Main.critDmg || 0),
                            w: safeFloat(wMain.critDmg),
                            sup: sumSup('critDmg'),
                            disc: disc4_CD + extraCD + safeFloat(set4Main.critDmg || 0),
                            field: field.critDmg
                        },
                        dmgBonus: {
                            a: safeFloat(aMain.dmgBonus) - safeFloat(set4Main.dmgBonus || 0),
                            w: safeFloat(wMain.dmgBonus),
                            sup: sumSup('dmgBonus'),
                            disc: extraDmg + safeFloat(set4Main.dmgBonus || 0),
                            field: field.dmgBonus
                        },
                        resShred: {
                            a: safeFloat(aMain.resShred),
                            w: safeFloat(wMain.resShred),
                            sup: sumSup('resShred'),
                            field: field.resShred
                        },
                        defShred: {
                            a: safeFloat(aMain.defShred),
                            w: safeFloat(wMain.defShred),
                            sup: sumSup('defShred'),
                            field: field.defShred
                        },
                        penPct: {
                            a: safeFloat(aMain.penRatio),
                            w: safeFloat(wMain.penRatio),
                            sup: sumSup('penRatio'),
                            disc: extraPenPct
                        },
                        penVal: {
                            a: safeFloat(aMain.penValue),
                            w: safeFloat(wMain.penValue),
                            sup: sumSup('penValue')
                        }
                    }
                }
            };
        }

        function calculateAll() {
            // æ ¸å¿ƒé€»è¾‘æ›´æ–°ï¼šæ— è®ºä½•ç§æ¨¡å¼ï¼Œéƒ½è¿è¡Œä¸€æ¬¡æœ€ä¼˜è®¡ç®—çš„æ•°æ®ç”Ÿæˆéƒ¨åˆ†ï¼Œ
            // ä»¥ä¾¿åœ¨æ‰‹åŠ¨æ¨¡å¼ä¸‹è®¡ç®—â€œä¸æœ€ä¼˜é…ç½®çš„å·®è·â€ã€‚
            runOptimizationDataOnly();

            // å§‹ç»ˆæ›´æ–°æ‰‹åŠ¨æ¨¡å¼çš„é¢æ¿å’Œæ—¥å¿—ï¼Œç¡®ä¿æ•°æ®ä¸æ»å
            manualUpdate();

            // ä»…åœ¨è‡ªåŠ¨æ¨¡å¼å¼€å¯æ—¶æ›´æ–°å›¾è¡¨å’Œè‡ªåŠ¨æ¨¡å¼UI
            if (globalState.mode === 'auto') {
                let currentStepBtn = document.querySelector('.opt-controls button.active[id^="btn-"]');
                let steps = currentStepBtn ? parseInt(currentStepBtn.id.split('-')[1]) : 30;
                updateChartLine(steps);
            }
        }

        function renderPanel(containerId, d) {
            const el = document.getElementById(containerId);
            let rows = '';

            if (globalState.battleType === 'break') {
                rows = `
                    <div class="panel-row"><span>æ€»è´¯ç©¿åŠ›</span><span>${Math.floor(d.totalPierce)}</span></div>
                     <div class="panel-row"><span>å±€å†…æœ€å¤§ç”Ÿå‘½</span><span>${Math.floor(d.maxHpInCombat || 0)}</span></div>
                    <div class="panel-row"><span>æš´å‡»ç‡</span><span>${d.totalCR.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>æš´å‡»ä¼¤å®³</span><span>${d.totalCD.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>å¢ä¼¤åŒº</span><span>${d.totalDmgBonus.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>å‡æŠ—</span><span>${d.totalResShred.toFixed(1)}%</span></div>
                `;
            } else {
                rows = `
                    <div class="panel-row"><span>æ€»æ”»å‡»åŠ›</span><span>${Math.floor(d.totalAtk)}</span></div>
                    <div class="panel-row"><span>æš´å‡»ç‡</span><span>${d.totalCR.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>æš´å‡»ä¼¤å®³</span><span>${d.totalCD.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>å¢ä¼¤åŒº</span><span>${d.totalDmgBonus.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>ç©¿é€ç‡</span><span>${d.totalPenPct.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>ç©¿é€å€¼</span><span>${d.totalPenVal.toFixed(0)}</span></div>
                    <div class="panel-row"><span>æ— è§†é˜²å¾¡(å‡é˜²)</span><span>${d.totalDefShred.toFixed(1)}%</span></div>
                    <div class="panel-row"><span>å‡æŠ—</span><span>${d.totalResShred.toFixed(1)}%</span></div>
                `;
            }
            el.innerHTML = rows;
        }

        function manualUpdate() {
            let crCount = safeFloat(document.getElementById('sub-cr-count').value);
            let cdCount = safeFloat(document.getElementById('sub-cd-count').value);

            // Branch logic for Atk vs Hp based on mode
            let atkCount = 0;
            let hpCount = 0;
            let slot5SelectId, set2SelectId;

            if (globalState.battleType === 'break') {
                hpCount = safeFloat(document.getElementById('sub-hp-count').value);
                slot5SelectId = 'slot5-select-break';
                set2SelectId = 'set2-select-break';
            } else {
                atkCount = safeFloat(document.getElementById('sub-atk-count').value);
                slot5SelectId = 'slot5-select';
                set2SelectId = 'set2-select';
            }

            let totalSubs = crCount + cdCount + atkCount + hpCount;
            const warnEl = document.getElementById('sub-total-warn');
            if (totalSubs > 48) {
                warnEl.innerText = `è­¦å‘Š: è¯æ¡æ€»æ•° ${totalSubs} è¶…è¿‡ 48!`;
            } else {
                warnEl.innerText = `å½“å‰è¯æ¡æ•°: ${totalSubs} / 48`;
            }

            let slot5 = document.getElementById(slot5SelectId).value;
            let set2 = document.getElementById(set2SelectId).value;

            let extraStats = {
                critRate: crCount * 2.4,
                critDmg: cdCount * 4.8,
                atkPct: atkCount * 3.0,
                hpPct: hpCount * 3.0, // Added HP
                slot5_AtkPct: 0, slot5_Dmg: 0, slot5_Pen: 0, slot5_HpPct: 0,
                set2_Dmg: 0, set2_Pen: 0, set2_AtkPct: 0, set2_CD: 0, set2_HpPct: 0
            };

            // Slot 5 Logic
            if (slot5 === 'atk') extraStats.slot5_AtkPct = 30;
            else if (slot5 === 'dmg') extraStats.slot5_Dmg = 30;
            else if (slot5 === 'pen') extraStats.slot5_Pen = 24;
            else if (slot5 === 'hp') extraStats.slot5_HpPct = 30; // Added HP

            // Set 2 Logic
            if (set2 === 'atk') extraStats.set2_AtkPct = 10;
            else if (set2 === 'dmg') extraStats.set2_Dmg = 10;
            else if (set2 === 'pen') extraStats.set2_Pen = 8;
            else if (set2 === 'cd') extraStats.set2_CD = 16;
            else if (set2 === 'hp') extraStats.set2_HpPct = 10; // Added HP

            let result = calculateDamage(extraStats);

            // Gains
            let baseDmg = result.dmg;
            let safeDiv = (val) => baseDmg > 0 ? val : 0;

            let gainCR = safeDiv((calculateDamage({ ...extraStats, critRate: extraStats.critRate + 2.4 }).dmg - baseDmg) / baseDmg * 100);
            let gainCD = safeDiv((calculateDamage({ ...extraStats, critDmg: extraStats.critDmg + 4.8 }).dmg - baseDmg) / baseDmg * 100);

            document.getElementById('gain-cr').innerText = `æ”¶ç›Š: +${gainCR.toFixed(2)}%`;
            document.getElementById('gain-cd').innerText = `æ”¶ç›Š: +${gainCD.toFixed(2)}%`;

            if (globalState.battleType === 'break') {
                let gainHp = safeDiv((calculateDamage({ ...extraStats, hpPct: extraStats.hpPct + 3.0 }).dmg - baseDmg) / baseDmg * 100);
                document.getElementById('gain-hp').innerText = `æ”¶ç›Š: +${gainHp.toFixed(2)}%`;
            } else {
                let gainAtk = safeDiv((calculateDamage({ ...extraStats, atkPct: extraStats.atkPct + 3.0 }).dmg - baseDmg) / baseDmg * 100);
                document.getElementById('gain-atk').innerText = `æ”¶ç›Š: +${gainAtk.toFixed(2)}%`;
            }

            let noSlot5Stats = { ...extraStats, slot5_AtkPct: 0, slot5_Dmg: 0, slot5_Pen: 0, slot5_HpPct: 0 };
            let dmgNoSlot5 = calculateDamage(noSlot5Stats).dmg;
            let gainSlot5 = dmgNoSlot5 > 0 ? (baseDmg - dmgNoSlot5) / dmgNoSlot5 * 100 : 0;
            document.getElementById('gain-slot5').innerText = `å½“å‰é€‰æ‹©æ”¶ç›Š: +${gainSlot5.toFixed(2)}%`;

            let noSet2Stats = { ...extraStats, set2_Dmg: 0, set2_Pen: 0, set2_AtkPct: 0, set2_CD: 0, set2_HpPct: 0 };
            let dmgNoSet2 = calculateDamage(noSet2Stats).dmg;
            let gainSet2 = dmgNoSet2 > 0 ? (baseDmg - dmgNoSet2) / dmgNoSet2 * 100 : 0;
            document.getElementById('gain-set2').innerText = `å½“å‰é€‰æ‹©æ”¶ç›Š: +${gainSet2.toFixed(2)}%`;

            displayLog(result);
            renderPanel('manual-panel', result.details);

            // Gap Calculation
            let optDmg = 0;
            if (globalState.allOptResults.length > 0) {
                // Find max damage for current step (totalSubs)
                let checkStep = Math.min(48, Math.max(0, totalSubs));
                globalState.allOptResults.forEach(res => {
                    // FIX: Use .find() because array index doesn't match step when startTotal > 0
                    let stepData = res.history.find(h => h.step === checkStep);
                    if (stepData && stepData.dmg > optDmg) optDmg = stepData.dmg;
                });
            }

            let gapStr = '';
            if (optDmg > 0 && baseDmg > 0) {
                let diff = (baseDmg - optDmg) / optDmg * 100;
                // å·®è·é€šå¸¸ä¸ºè´Ÿæ•°
                let color = diff > -1 ? 'var(--zzz-primary)' : 'var(--zzz-alert)';
                gapStr = `<br><span style="font-size:0.9rem; color:#888;">(ä¸${totalSubs}è¯æ¡æœ€ä¼˜è§£å·®è·: <span style="color:${color}">${diff.toFixed(2)}%</span>)</span>`;
            }

            const manualPanel = document.getElementById('manual-panel');
            manualPanel.innerHTML += `<div class="panel-row" style="color:var(--zzz-primary); font-weight:bold; margin-top:5px; border-top:1px solid #444; padding-top:5px; display:block; text-align:right;">
            <div style="display:flex; justify-content:space-between;"><span>æœ€ç»ˆä¼¤å®³</span><span>${Math.floor(result.dmg)}</span></div>
            ${gapStr}
        </div>`;
        }

        // ... existing code ...

        function updateChartLine(steps) {
            ['30', '36', '42'].forEach(n => {
                document.getElementById(`btn-${n}`).classList.toggle('active', n == steps);
            });

            if (!globalState.allOptResults.length) return;

            // æ ¸å¿ƒé€»è¾‘ä¿®å¤ï¼šåœ¨æ‰€æœ‰æ–¹æ¡ˆä¸­ï¼Œå¯»æ‰¾åœ¨å½“å‰ steps æ­¥æ•°ä¸‹ä¼¤å®³æœ€é«˜çš„æ–¹æ¡ˆ
            let bestResult = null;
            let maxDmg = -1;

            globalState.allOptResults.forEach(res => {
                // è·å–è¯¥æ–¹æ¡ˆåœ¨ step å¤„çš„ä¼¤å®³
                // FIX: Use .find() because array index doesn't match step
                let stepData = res.history.find(h => h.step === steps);
                if (stepData && stepData.dmg > maxDmg) {
                    maxDmg = stepData.dmg;
                    bestResult = res;
                }
            });

            if (!bestResult) return;

            // è®¾ç½®å½“å‰æ˜¾ç¤ºçš„æ•°æ®ä¸ºè¯¥â€œæœ€ä¼˜æ–¹æ¡ˆâ€çš„å†å²æ•°æ®
            globalState.optData = bestResult.history;
            let currentStepData = bestResult.history.find(h => h.step === steps);

            // é‡æ–°ç»˜åˆ¶å›¾è¡¨ï¼Œæ˜¾ç¤ºè¯¥æœ€ä¼˜æ–¹æ¡ˆçš„æ›²çº¿
            drawChart(bestResult.history);

            // Update Config Display
            document.getElementById('opt-config-val').innerText = currentStepData.configName;

            if (globalState.battleType === 'break') {
                document.getElementById('opt-sub-stats').innerText =
                    `æš´å‡»ç‡ ${currentStepData.counts.cr} | æš´å‡»ä¼¤å®³ ${currentStepData.counts.cd} | ç”Ÿå‘½å€¼ ${currentStepData.counts.hp}`;
            } else {
                document.getElementById('opt-sub-stats').innerText =
                    `æš´å‡»ç‡ ${currentStepData.counts.cr} | æš´å‡»ä¼¤å®³ ${currentStepData.counts.cd} | æ”»å‡»åŠ› ${currentStepData.counts.atk}`;
            }

            // Update Panel
            renderPanel('opt-panel', calculateDamage(currentStepData.stats).details);
            document.getElementById('opt-dmg').innerText = Math.floor(currentStepData.dmg).toLocaleString();

            // Update Chart Line Position
            if (globalState.chart) {
                globalState.chart.config._activeStep = steps;
                globalState.chart.update(); // ä½¿ç”¨ update è€Œä¸æ˜¯ draw ç¡®ä¿æ ‡çº¿åˆ·æ–°
            }
        }

        function displayLog(res) {
            let d = res.details;
            let b = d.breakdown;

            // Tooltip helper with Title - using HTML structure now
            // NOTE: We put all on one line or use template literals carefully to generate valid HTML string.
            const t = (val, title, content) =>
                `<span class="u-tooltip">${val}<span class="u-tooltip-content"><span class="u-tooltip-title">${title}</span>${content}</span></span>`;

            // Breakdown Strings
            const strBase = `ä»£ç†äºº: ${Math.floor(b.baseAtk.a)}\néŸ³æ“: ${Math.floor(b.baseAtk.w)}`;
            const strOutPct = `ä»£ç†äºº: ${b.outCombatAtkPct.a}%\néŸ³æ“: ${b.outCombatAtkPct.w}%\nè¾…åŠ©: ${b.outCombatAtkPct.sup}%\né©±åŠ¨ç›˜: ${b.outCombatAtkPct.disc}%`;
            const strInPct = `ä»£ç†äºº: ${b.inCombatAtkPct.a}%\néŸ³æ“: ${b.inCombatAtkPct.w}%\nè¾…åŠ©: ${b.inCombatAtkPct.sup}%\né©±åŠ¨ç›˜: ${b.inCombatAtkPct.disc || 0}%\nåœºåœ°: ${b.inCombatAtkPct.field}%`;
            const strInFlat = `ä»£ç†äºº: ${b.inCombatFlatAtk.a}\néŸ³æ“: ${b.inCombatFlatAtk.w}\nè¾…åŠ©: ${b.inCombatFlatAtk.sup}\né©±åŠ¨ç›˜: ${b.inCombatFlatAtk.disc}`;

            const strCR = `ä»£ç†äºº: ${b.totalCR.a}%\néŸ³æ“: ${b.totalCR.w}%\nè¾…åŠ©: ${b.totalCR.sup}%\né©±åŠ¨ç›˜: ${b.totalCR.disc}%\nåœºåœ°: ${b.totalCR.field}%`;
            const strCD = `ä»£ç†äºº: ${b.totalCD.a}%\néŸ³æ“: ${b.totalCD.w}%\nè¾…åŠ©: ${b.totalCD.sup}%\né©±åŠ¨ç›˜: ${b.totalCD.disc}%\nåœºåœ°: ${b.totalCD.field}%`;
            const strDmg = `ä»£ç†äºº: ${b.dmgBonus.a}%\néŸ³æ“: ${b.dmgBonus.w}%\nè¾…åŠ©: ${b.dmgBonus.sup}%\né©±åŠ¨ç›˜: ${b.dmgBonus.disc}%\nåœºåœ°: ${b.dmgBonus.field}%`;

            const strRes = `ä»£ç†äºº: ${b.resShred.a}%\néŸ³æ“: ${b.resShred.w}%\nè¾…åŠ©: ${b.resShred.sup}%\nåœºåœ°: ${b.resShred.field}%`;
            const strDefShred = `ä»£ç†äºº: ${b.defShred.a}%\néŸ³æ“: ${b.defShred.w}%\nè¾…åŠ©: ${b.defShred.sup}%\nåœºåœ°: ${b.defShred.field}%`;
            const strPen = `ç©¿é€ç‡(å’Œ): ${d.totalPenPct.toFixed(1)}%\nç©¿é€å€¼(å’Œ): ${d.totalPenVal.toFixed(0)}`;


            let log = '';

            if (globalState.battleType === 'break') {
                // Break Mode Display
                log = `è®¡ç®—å…¬å¼ (å‘½ç ´æ¨¡å¼)ï¼š
ä¼¤å®³ = æŠ€èƒ½å€ç‡ * è´¯ç©¿åŠ› * (1+å¢ä¼¤) * (1+æš´å‡»ç‡*æš´å‡»ä¼¤å®³) * (1-æŠ—æ€§+å¼±ç‚¹+å‡æŠ—) * ((åŸºç¡€å¤±è¡¡+å¤±è¡¡æ˜“ä¼¤)/100) * (1+è´¯ç©¿å¢ä¼¤)

è¯¦ç»†æ•°å€¼ (é¼ æ ‡æ‚¬åœæŸ¥çœ‹æ¥æº)ï¼š
1. è´¯ç©¿åŠ›åŒºï¼š
   æ€»è´¯ç©¿åŠ› = ${Math.floor(d.totalPierce)}

2. æš´å‡»åŒº (æœŸæœ›)ï¼š
   1 + (${t(d.totalCR.toFixed(1) + '%', 'æ€»æš´å‡»ç‡', strCR)} * ${t(d.totalCD.toFixed(1) + '%', 'æ€»æš´å‡»ä¼¤å®³', strCD)}) = ${(1 + (Math.min(d.totalCR, 100) / 100) * (d.totalCD / 100)).toFixed(3)}

3. å¢ä¼¤åŒºï¼š
   1 + ${t(d.totalDmgBonus.toFixed(1) + '%', 'æ€»å¢ä¼¤', strDmg)} = ${((1 + d.totalDmgBonus / 100)).toFixed(3)}

4. æŠ—æ€§åŒºï¼š
   1 - ${d.enemyRes} (æŠ—æ€§) + ${d.weaknessVal} (å¼±ç‚¹) + ${t((d.totalResShred / 100).toFixed(2), 'å‡æŠ—ç³»æ•°', strRes)} (å‡æŠ—) = ${d.resMult.toFixed(3)}

5. å¤±è¡¡åŒºï¼š
   (${d.baseDaze} + ${d.totalDazeVuln.toFixed(1)}) / 100 = ${d.dazeMult.toFixed(3)}

6. æœ€ç»ˆä¼¤å®³ï¼š
   ${Math.floor(res.dmg)}`;
            } else {
                // Attack Mode Display
                log = `è®¡ç®—å…¬å¼ (å¼ºæ”»æ¨¡å¼)ï¼š
ä¼¤å®³ = æŠ€èƒ½å€ç‡ * ((ç™½å€¼*å±€å¤–% + å±€å¤–å›ºå®š) * (1+<span class="in-combat-highlight">å±€å†…%</span>) + <span class="in-combat-highlight">å±€å†…å›ºå®š</span>) * (1+å¢ä¼¤) * (1+æš´å‡»*çˆ†ä¼¤) * (1-æŠ—æ€§+å¼±ç‚¹+å‡æŠ—) * (794 / (((é˜²å¾¡*(1+åŠ æˆ-å‡é˜²))*(1-ç©¿é€ç‡)-ç©¿é€å€¼)+794)) * ((åŸºç¡€å¤±è¡¡+å¤±è¡¡æ˜“ä¼¤)/100)

è¯¦ç»†æ•°å€¼ (é¼ æ ‡æ‚¬åœæŸ¥çœ‹æ¥æº)ï¼š
1. æ”»å‡»åŠ›åŒºï¼š
   å±€å¤– = (${t(d.baseAtk, 'åŸºç¡€æ”»å‡»åŠ›', strBase)} * (1+${t(d.outCombatAtkPct.toFixed(1) + '%', 'å±€å¤–æ”»å‡»%', strOutPct)}) + ${d.outCombatFlatAtk}) = ${Math.floor(d.sheetAtk)}
   å±€å†… = ${Math.floor(d.sheetAtk)} * (1+<span class="in-combat-highlight">${t(d.inCombatAtkPct.toFixed(1) + '%', 'å±€å†…æ”»å‡»%', strInPct)}</span>) + <span class="in-combat-highlight">${t(d.inCombatFlatAtk, 'å±€å†…å›ºå®šæ”»å‡»', strInFlat)}</span> = ${Math.floor(d.totalAtk)}

2. æš´å‡»åŒº (æœŸæœ›)ï¼š
   1 + (${t(d.totalCR.toFixed(1) + '%', 'æ€»æš´å‡»ç‡', strCR)} * ${t(d.totalCD.toFixed(1) + '%', 'æ€»æš´å‡»ä¼¤å®³', strCD)}) = ${(1 + (Math.min(d.totalCR, 100) / 100) * (d.totalCD / 100)).toFixed(3)}

3. å¢ä¼¤åŒºï¼š
   1 + ${t(d.totalDmgBonus.toFixed(1) + '%', 'æ€»å¢ä¼¤', strDmg)} = ${((1 + d.totalDmgBonus / 100)).toFixed(3)}

4. æŠ—æ€§åŒºï¼š
   1 - ${d.enemyRes} (æŠ—æ€§) + ${d.weaknessVal} (å¼±ç‚¹) + ${t((d.totalResShred / 100).toFixed(2), 'å‡æŠ—ç³»æ•°', strRes)} (å‡æŠ—) = ${d.resMult.toFixed(3)}

5. é˜²å¾¡åŒºï¼š
   é˜²å¾¡å€¼ = (${d.baseDef} * (1+${d.defBonus / 100}-${t((d.totalDefShred / 100).toFixed(2), 'é˜²å¾¡å‰Šå‡', strDefShred)})) * (1-${d.totalPenPct / 100}) - ${d.totalPenVal} = ${t(d.defRes.toFixed(1), 'ç©¿é€è®¡ç®—', strPen)}
   ç³»æ•° = 794 / (${d.defRes.toFixed(1)} + 794) = ${d.defMult.toFixed(4)}

6. æœ€ç»ˆä¼¤å®³ï¼š
   ${Math.floor(res.dmg)}`;
            }

            if (res.warnings.length > 0) {
                log += `\n\n<span class="alert-text">[å¼‚å¸¸å‘Šè­¦]:\n` + res.warnings.join('\n') + `</span>`;
            }
            document.getElementById('calc-log').innerHTML = log;
        }

        // --- Optimization Mode Logic ---
        function switchMode(mode) {
            globalState.mode = mode;
            document.getElementById('mode-manual-btn').classList.toggle('active', mode === 'manual');
            document.getElementById('mode-auto-btn').classList.toggle('active', mode === 'auto');
            document.getElementById('manual-ui').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('auto-ui').style.display = mode === 'auto' ? 'block' : 'none';

            calculateAll();
        }

        function runOptimizationDataOnly() {
            // Define config groups to verify
            let slot5Opts, set2Opts;

            if (globalState.battleType === 'break') {
                slot5Opts = [
                    { val: { slot5_AtkPct: 30 }, name: '5å·ä½:æ”»å‡»' },
                    { val: { slot5_Dmg: 30 }, name: '5å·ä½:å¢ä¼¤' },
                    { val: { slot5_HpPct: 30 }, name: '5å·ä½:ç”Ÿå‘½' }
                ];
                set2Opts = [
                    { val: { set2_Dmg: 10 }, name: '2ä»¶å¥—:å¢ä¼¤' },
                    { val: { set2_Pen: 8 }, name: '2ä»¶å¥—:ç©¿é€' }, // Pen still valid from set? The request said replace Atk with HP. 
                    { val: { set2_HpPct: 10 }, name: '2ä»¶å¥—:ç”Ÿå‘½' },
                    { val: { set2_CD: 16 }, name: '2ä»¶å¥—:çˆ†ä¼¤' }
                ];
            } else {
                slot5Opts = [
                    { val: { slot5_AtkPct: 30 }, name: '5å·ä½:æ”»å‡»' },
                    { val: { slot5_Dmg: 30 }, name: '5å·ä½:å¢ä¼¤' },
                    { val: { slot5_Pen: 24 }, name: '5å·ä½:ç©¿é€' }
                ];
                set2Opts = [
                    { val: { set2_AtkPct: 10 }, name: '2ä»¶å¥—:æ”»å‡»' },
                    { val: { set2_Dmg: 10 }, name: '2ä»¶å¥—:å¢ä¼¤' },
                    { val: { set2_Pen: 8 }, name: '2ä»¶å¥—:ç©¿é€' },
                    { val: { set2_CD: 16 }, name: '2ä»¶å¥—:çˆ†ä¼¤' }
                ];
            }

            let allResults = [];


            // è¯»å–å·²æœ‰å‰¯è¯æ¡æ•°é‡
            let startCR = safeFloat(document.getElementById('auto-cr-count').value);
            let startCD = safeFloat(document.getElementById('auto-cd-count').value);
            let startAtk = 0;
            let startHp = 0;
            if (globalState.battleType === 'break') {
                startHp = safeFloat(document.getElementById('auto-hp-count').value);
            } else {
                startAtk = safeFloat(document.getElementById('auto-atk-count').value);
            }

            let startTotal = startCR + startCD + startAtk + startHp;

            // éå†æ‰€æœ‰å¯èƒ½ãªçµ„åˆã›
            for (let s5 of slot5Opts) {
                for (let s2 of set2Opts) {
                    let currentStats = {
                        critRate: startCR * 2.4,
                        critDmg: startCD * 4.8,
                        atkPct: startAtk * 3.0,
                        hpPct: startHp * 3.0,
                        ...s5.val, ...s2.val
                    };
                    let history = [];
                    let currentDmg = calculateDamage(currentStats).dmg;
                    let counts = { cr: startCR, cd: startCD, atk: startAtk, hp: startHp };

                    // Step 0 - å®é™…ä¸Šæ˜¯ startTotal
                    history.push({
                        step: startTotal, dmg: currentDmg,
                        stats: { ...currentStats }, configName: `${s5.name} + ${s2.name}`,
                        gains: { cr: 0, cd: 0, atk: 0, hp: 0 },
                        counts: { ...counts }
                    });

                    // è´ªå¿ƒç®—æ³•æ¨¡æ‹Ÿè‡³48è¯æ¡
                    for (let step = startTotal + 1; step <= 48; step++) {
                        let dCR = calculateDamage({ ...currentStats, critRate: currentStats.critRate + 2.4 }).dmg;
                        let dCD = calculateDamage({ ...currentStats, critDmg: currentStats.critDmg + 4.8 }).dmg;

                        let dAtk, dHp, bestMove;
                        if (globalState.battleType === 'break') {
                            dHp = calculateDamage({ ...currentStats, hpPct: currentStats.hpPct + 3.0 }).dmg;
                            bestMove = Math.max(dCR, dCD, dHp);
                        } else {
                            dAtk = calculateDamage({ ...currentStats, atkPct: currentStats.atkPct + 3.0 }).dmg;
                            bestMove = Math.max(dCR, dCD, dAtk);
                        }

                        let gCR = (dCR - currentDmg) / currentDmg * 100;
                        let gCD = (dCD - currentDmg) / currentDmg * 100;
                        let gAtk = (dAtk && dAtk > 0) ? (dAtk - currentDmg) / currentDmg * 100 : 0;
                        let gHp = (dHp && dHp > 0) ? (dHp - currentDmg) / currentDmg * 100 : 0;

                        if (bestMove === dCR) { currentStats.critRate += 2.4; counts.cr++; }
                        else if (bestMove === dCD) { currentStats.critDmg += 4.8; counts.cd++; }
                        else if (globalState.battleType === 'break' && bestMove === dHp) { currentStats.hpPct += 3.0; counts.hp++; }
                        else { currentStats.atkPct += 3.0; counts.atk++; }

                        currentDmg = bestMove;
                        history.push({
                            step: step,
                            dmg: currentDmg,
                            stats: { ...currentStats },
                            configName: `${s5.name} + ${s2.name}`,
                            gains: { cr: gCR, cd: gCD, atk: gAtk, hp: gHp },
                            counts: { ...counts }
                        });
                    }

                    // ä¿å­˜è¯¥ç»„åˆçš„å®Œæ•´å†å²
                    allResults.push({
                        name: `${s5.name} + ${s2.name}`,
                        history: history
                    });
                }
            }

            globalState.allOptResults = allResults;
        }

        // Alias to keep old logic if needed, but renamed to clarity
        function runOptimization() {
            runOptimizationDataOnly();
            let currentStepBtn = document.querySelector('.opt-controls button.active[id^="btn-"]');
            let steps = currentStepBtn ? parseInt(currentStepBtn.id.split('-')[1]) : 30;
            updateChartLine(steps);
        }

        // Chart Plugin for Vertical Line
        const verticalLinePlugin = {
            id: 'verticalLine',
            afterDatasetsDraw: (chart, args, options) => {
                if (chart.config._activeStep === undefined) return;
                const step = chart.config._activeStep;
                const ctx = chart.ctx;
                const xAxis = chart.scales.x;
                const yAxis = chart.scales.y;

                const x = xAxis.getPixelForValue(step);

                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, yAxis.top);
                ctx.lineTo(x, yAxis.bottom);
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#ffffff';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.restore();
            }
        };

        function drawChart(history) {
            const ctx = document.getElementById('optChart').getContext('2d');
            if (globalState.chart) globalState.chart.destroy();

            // åŒ…å« step 0
            const chartData = history;
            const labels = chartData.map(h => h.step);

            const dataCR = chartData.map(h => h.gains.cr);
            const dataCD = chartData.map(h => h.gains.cd);
            const data3 = chartData.map(h => globalState.battleType === 'break' ? h.gains.hp : h.gains.atk);
            const label3 = globalState.battleType === 'break' ? 'ç”Ÿå‘½å€¼å¢ç›Š' : 'æ”»å‡»åŠ›æ”¶ç›Š';

            globalState.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æš´å‡»ç‡æ”¶ç›Š', data: dataCR, borderColor: '#ff4d4d', borderWidth: 2, pointRadius: 1 },
                        { label: 'æš´å‡»ä¼¤å®³æ”¶ç›Š', data: dataCD, borderColor: '#dfff00', borderWidth: 2, pointRadius: 1 },
                        { label: label3, data: data3, borderColor: '#00ccff', borderWidth: 2, pointRadius: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(3)}%`;
                                },
                                footer: function (tooltipItems) {
                                    const idx = tooltipItems[0].dataIndex;
                                    const h = chartData[idx];
                                    if (globalState.battleType === 'break') {
                                        return `CR:${h.counts.cr} CD:${h.counts.cd} HP:${h.counts.hp}`;
                                    } else {
                                        return `CR:${h.counts.cr} CD:${h.counts.cd} Atk:${h.counts.atk}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            grid: { color: '#333' },
                            ticks: { color: '#888', stepSize: 3, maxTicksLimit: 20 },
                            title: { display: true, text: 'æ­¥æ•°', color: '#666' }
                        },
                        y: {
                            grid: { color: '#333' },
                            ticks: { color: '#888' },
                            title: { display: true, text: 'æ”¶ç›Šç‡ (%)', color: '#666' }
                        }
                    }
                },
                plugins: [verticalLinePlugin]
            });
        }



        function exportSnapshot() {
            const btn = document.getElementById('export-btn');
            const originalText = btn.innerText;
            btn.innerText = "ğŸ“¸ ç”Ÿæˆä¸­...";
            btn.classList.add('active');
            btn.disabled = true;

            // Hide video background to prevent rendering issues
            const videoBackground = document.querySelector('.video-background');
            const videoWasVisible = videoBackground && videoBackground.style.display !== 'none';
            if (videoBackground) {
                videoBackground.style.display = 'none';
            }

            // Hide the export button itself from the screenshot
            btn.style.visibility = 'hidden';

            // Allow time for UI updates and chart rendering
            setTimeout(() => {
                // Check if html2canvas is loaded
                if (typeof html2canvas === 'undefined') {
                    console.error('html2canvas library not loaded');
                    alert("å¯¼å‡ºåŠŸèƒ½åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•ã€‚");
                    restoreUI();
                    return;
                }

                html2canvas(document.body, {
                    useCORS: true,
                    allowTaint: true,
                    scrollY: -window.scrollY,
                    scrollX: -window.scrollX,
                    windowWidth: document.documentElement.scrollWidth,
                    windowHeight: document.documentElement.scrollHeight,
                    backgroundColor: '#050505',
                    scale: 2, // Higher quality export
                    logging: false,
                    imageTimeout: 15000,
                    onclone: (clonedDoc) => {
                        // Ensure charts are visible in cloned document
                        const charts = clonedDoc.querySelectorAll('canvas');
                        charts.forEach(chart => {
                            chart.style.display = 'block';
                        });
                    }
                }).then(canvas => {
                    try {
                        const link = document.createElement('a');
                        const date = new Date().toISOString().slice(0, 10);
                        const time = new Date().toLocaleTimeString('zh-CN', { hour12: false }).replace(/:/g, '-');
                        link.download = `ZZZ_é…ç½®_${date}_${time}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();

                        showToast("âœ… é…ç½®é•¿å›¾å·²æˆåŠŸå¯¼å‡ºï¼");
                    } catch (err) {
                        console.error('Export error:', err);
                        alert("å¯¼å‡ºå¤±è´¥ï¼šæ— æ³•ç”Ÿæˆå›¾ç‰‡ã€‚è¯·å°è¯•ä½¿ç”¨æµè§ˆå™¨çš„æˆªå›¾åŠŸèƒ½ã€‚");
                    } finally {
                        restoreUI();
                    }
                }).catch(err => {
                    console.error('html2canvas error:', err);
                    const errorMsg = err.message || 'æœªçŸ¥é”™è¯¯';
                    alert(`å¯¼å‡ºå¤±è´¥ï¼š${errorMsg}\n\nå»ºè®®ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦æˆªå›¾åŠŸèƒ½ï¼ˆå¦‚ Windows: Win+Shift+Sï¼‰ã€‚`);
                    restoreUI();
                });
            }, 300);

            function restoreUI() {
                // Restore video background
                if (videoBackground && videoWasVisible) {
                    videoBackground.style.display = '';
                }
                // Restore button
                btn.style.visibility = '';
                btn.innerText = originalText;
                btn.classList.remove('active');
                btn.disabled = false;
            }
        }

        // Video Scroll Logic
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('hero-video');
            if (!video) return;

            window.addEventListener('scroll', () => {
                const scrollY = window.scrollY;
                if (scrollY > 50) {
                    if (!video.classList.contains('is-blurred')) {
                        video.classList.add('is-blurred');
                        video.pause();
                    }
                } else {
                    if (video.classList.contains('is-blurred')) {
                        video.classList.remove('is-blurred');
                        // Handle Promise to avoid interruption error
                        let playPromise = video.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                // Auto-play was prevented
                                console.log("Video play interrupted or prevented");
                            });
                        }
                    }
                }
            });
        });
    </script>
</body>

</html>